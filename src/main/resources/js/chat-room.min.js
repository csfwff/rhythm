var el,ctx,catchWordFlag,isDrawing=!1,x=0,y=0,isClick=!0,thisClient="Web/PC网页端",BarragerColorPicker=null,DarwColorPicker=null,redPacketMap=new Map,catchUserParam=window.localStorage.robot_list?window.localStorage.robot_list:"",catchUsers=catchUserParam.length>0?catchUserParam.split(","):[];window.localStorage["catch-word-flag"]?catchWordFlag=1==window.localStorage["catch-word-flag"]||"true"==window.localStorage["catch-word-flag"]:(window.localStorage["catch-word-flag"]=!0,catchWordFlag=!0),$("#catch-word").prop("checked",catchWordFlag);var ChatRoom={init:function(){if(ChatRoom.isMobile()&&(thisClient="Mobile/移动网页端"),0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","|","link","upload","|","undo","redo","|","edit-mode","fullscreen",{name:"more",toolbar:["table","list","ordered-list","check","outdent","indent","quote","code","insert-before","insert-after","info","help"]}],height:150,placeholder:"说点什么吧！",ctrlEnter:function(){ChatRoom.send()}});let e=localStorage.getItem("user_remark");e&&(ChatRoom.remarkList=JSON.parse(e)),ChatRoom.listenUploadEmojis(),ChatRoom.loadEmojis(),(()=>{let e=(new Date).getTime(),t=0;const a=function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime(),t=setTimeout((()=>{(new Date).getTime()-e<=700&&$("#emojiList").removeClass("showList")}),null!==navigator.userAgent.match(/(phone|pad|pod|ios|Android|Mobile|BlackBerry|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian)/i)?0:600)};$("#emojiBtn").hover((function(a){$("#emojiList").css("top","290px"),0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime(),setTimeout((()=>0!==$("#emojiBtn:hover").length&&$("#emojiList").addClass("showList")),300)}),a),$("#emojiList").hover((function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime()}),a)})(),$("#redPacketBtn").on("click",(function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">红包类型</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="redPacketType">\n  <option value="random" selected>拼手气红包</option>  <option value="average">普通红包</option>  <option value="specify">专属红包</option>  <option value="heartbeat">心跳红包</option>  <option value="rockPaperScissors">猜拳红包</option>  </select>\n</label>\n<label id="gesture" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">出拳</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="gestureType">\n  <option value="0" selected>石头</option>  <option value="1">剪刀</option>  <option value="2">布</option>  </select>\n</label>\n<label id = "who" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">发给谁</div>\n  <div class="fn-hr5 fn__5"></div>\n  <div id="recivers" class="chats__users">\n                            </div> \n  <input id="userInput" type=\'text\' autocomplete=\'off\'> \n  <div class=\'selected-username-box\'><div id="chatUsernameSelectedPanel" class="selected-username-panel"\n                             style="height:170px;"></div><div class=\'arrow_up\'></div></div> \n</label>\n<label id=\'redPacketMoneyLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label id=\'redPacketCountLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left" id="countx">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div id=\'totalAmount\' class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包");var e=[],t=0;$("#userInput").on("focus input",(function(){var n=$("#userInput").val().toUpperCase();clearTimeout(t),$(".selected-username-box").hide(),$("#chatUsernameSelectedPanel").html("");var s="";a.forEach(((e,t)=>{t.toUpperCase().includes(n)&&(s+=`<div class="candidateName">${t}</div>`)})),$("#chatUsernameSelectedPanel").html(s),$(".selected-username-box").show(),$(".candidateName").on("click",(function(){let t=$(this).html();if(console.log(e.includes(t)),!e.includes(t)){e.push(t);var n=[];for(index in e)n.push(a.get(e[index]));for(var s in $("#recivers").html(""),$("#redPacketCount").val(n.length),n)$("#recivers").append('<a target="_blank" data-name="'+n[s].userName+'"\nhref="'+n[s].homePage+'">\n<img style=\'margin-bottom: 10px\' class="avatar avatar-small" aria-label="'+n[s].userName+'"\nsrc="'+n[s].userAvatarURL+'">\n</a>')}}))})),$("#userInput").on("blur",(function(){t=setTimeout((()=>{$(".selected-username-box").hide()}),500)}));var a=new Map;$("#redPacketType").on("change",(function(){let e=$("#redPacketType").val();"specify"===e?($("#who").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$.ajax({url:Label.servePath+"/chat-room/online-users",type:"GET",cache:!1,success:function(e){if(0==e.code)for(var t in $("#userOption").html(""),e.data.users){var n=e.data.users[t];a.set(n.userName,n)}},error:function(e){}})):($("#who").css("display","none"),$("#gesture").css("display","none"),$("#redPacketCount").removeAttr("readOnly"),$("#redPacketMoneyLabel").removeAttr("style"),$("#totalAmount").css("display","inline"),$("#countx").text("个数"),$("#redPacketCount").val("1")),"heartbeat"===e&&($("#countx").text("个数（最少5个）"),$("#redPacketCount").val("5")),"rockPaperScissors"===e&&($("#gesture").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")),"dice"===e&&($("#redPacketMoneyLabel").css("display","none"),$("#totalAmount").css("display","none"),$("#countx").text("开盘人数"),$("#redPacketCount").val("3"))})),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",(function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("32"),$("#redPacketMoney").val()<32&&$("#redPacketMoney").val("32"),$("#redPacketAmount").text($("#redPacketMoney").val()),"rockPaperScissors"===$("#redPacketType").val()&&$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")})),$("#redPacketMoney,#redPacketCount").bind("input propertychange",(function(){let e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e&&$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")})),$("#redPacketType").on("change",(function(){let e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e?$("#redPacketMsg").val("石头剪刀布！"):"dice"===e&&$("#redPacketMsg").val("买定离手！")})),$("#redPacketCount").on("change",(function(){let e=$("#redPacketType").val();"dice"===e&&($("#redPacketCount").val()>15&&$("#redPacketCount").val("15"),$("#redPacketCount").val()<3&&$("#redPacketCount").val("3")),"heartbeat"===e&&$("#redPacketCount").val()<5&&$("#redPacketCount").val("5"),Number($("#redPacketCount").val())>Number($("#redPacketMoney").val())?$("#redPacketCount").val($("#redPacketMoney").val()):($("#redPacketCount").val()>100&&$("#redPacketCount").val("100"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1"))})),$("#redPacketConfirm").on("click",(function(){let t,a=$("#redPacketType").val(),n=$("#redPacketMoney").val(),s=$("#redPacketCount").val(),o=$("#redPacketMsg").val(),i=e,l=$("#gestureType").val();""!==a&&null!=a||(a="random"),void 0===i&&(i=[]),0==i.length&&"specify"===a&&$("#chatContentTip").addClass("error").html("<ul><li>请选择红包发送对象</li></ul>"),""===o&&(o="摸鱼者，事竟成！"),t="rockPaperScissors"!==a?{type:a,money:n,count:s,msg:o,recivers:i}:{type:a,money:n,count:s,msg:o,recivers:i,gesture:l};let r={content:"[redpacket]"+JSON.stringify(t)+"[/redpacket]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(r),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()}))})),ChatRoom.loadAvatarPendant(),ChatRoom.initCatchUser(),ChatRoom.charInit("paintCanvas"),$("#barragerBtn").on("click",(function(){"none"===$("#barragerContent").css("display")?($("#barragerContent").slideDown(1e3),$("#paintContent").slideUp(1e3)):$("#barragerContent").slideUp(1e3)})),$("#barragerInput").keydown((function(e){13==e.keyCode&&ChatRoom.sendBarrager()})),$("#paintBtn").on("click",(function(){"none"===$("#paintContent").css("display")?($("#paintContent").slideDown(1e3),$("#barragerContent").slideUp(1e3)):$("#paintContent").slideUp(1e3)})),BarragerColorPicker=new XNColorPicker({color:"#ffffff",selector:"#selectBarragerColor",showhistorycolor:!1,colorTypeOption:"single",autoConfirm:!0,onError:function(e){},onCancel:function(e){},onChange:function(e){},onConfirm:function(e){}}),DarwColorPicker=new XNColorPicker({color:"#000000",selector:"#selectColor",showhistorycolor:!1,colorTypeOption:"single",autoConfirm:!0,onError:function(e){},onCancel:function(e){},onChange:function(e){ChatRoom.changeColor(e.color.rgba)},onConfirm:function(e){ChatRoom.changeColor(e.color.rgba)}}),$("#selectWidth").bind("change",(function(){let e=$("#selectWidth").val();ChatRoom.changeWidth(e)})),"true"===(localStorage.getItem("smoothMode")||"false")?ChatRoom.enableSmoothMode():setInterval(ChatRoom.reloadMessages,9e5)},enableSmoothMode:function(){console.log("Smooth mode enabling..."),$("#smoothMode").html("开启"),setInterval(ChatRoom.reloadMessages,3e3)},toggleSmoothMode:function(){let e;e="开启"===$("#smoothMode").html()?"false":"true",localStorage.setItem("smoothMode",e),"true"===e?(Util.notice("success",5e3,"流畅模式已开启，占用内存更小，体验更流畅。"),ChatRoom.enableSmoothMode()):location.reload()},sendBarrager:function(){let e={color:BarragerColorPicker.color.rgba,content:$("#barragerInput").val()},t={content:"[barrager]"+JSON.stringify(e)+"[/barrager]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),success:function(e){0!==e.code?$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>"):$("#barragerInput").val("")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}})},reloadMessages:function(){document.documentElement.scrollTop<=2e3&&ChatRoom.flashScreenQuiet()},flashScreen:function(){NProgress.start(),$("#chats").css("display","none"),page=1;let e=$("#chats>div");if(e.length>25)for(let t=e.length-1;t>24;t--)e[t].remove();setTimeout((function(){$("#chats").css("display","block"),NProgress.done()}),150)},flashScreenQuiet:function(){page=1;let e=$("#chats>div");if(e.length>25)for(let t=e.length-1;t>24;t--)e[t].remove()},showSiGuoYar:function(){Util.alert('\n<style>\n.dialog-panel {\nborder-radius: 20px 20px 20px 20px;\nborder: 0;\nbox-shadow: none;\n}\n.dialog-header-bg {\ndisplay: none;\n}\n.dialog-main {\nheight: 456px;\noverflow: auto;\npadding: 10px 10px 20px !important;\ncolor: #e1e1e1;\nbackground: url(https://file.fishpi.cn/2023/04/面壁-5e5b04c3.jpg) no-repeat;\nbackground-size: 100% 100%;\nbackground-attachment: fixed;\nfont-family: STKaiti;\n}\n.list>ul {\nmargin-top: 15px;\n}\n.list>ul>li {\npadding: 6px 8px;\nborder-bottom: none;\n}\n</style>\n<div class="fn-hr5"></div>\n<div class="ft__center">\n    <div>\n        <h2>思過崖</h2>\n        <div class="fn-hr5"></div>\n        <span>摸魚派倡導自由、友善的交流環境。<br>這裏收留了因不遵守摸魚法則而受到處罰的魚油。</span>\n    </div>\n    <div class="list">\n    <ul id="si-guo-list">\n    </ul>\n    </div>\n</div>'),$.ajax({url:Label.servePath+"/chat-room/si-guo-list",type:"GET",cache:!1,async:!1,success:function(e){let t=e.data;0==t.length&&$("#si-guo-list").prepend('<li style="color: #3caf36; font-weight: bold;">目前沒有受到處罰的魚油，請繼續保持！</li>');for(let e=0;e<t.length;e++){let a=t[e],n=new Date(a.time),s=a.userAvatarURL,o=a.userName,i=a.userNickname,l=o;""!=i&&(l=i),$("#si-guo-list").prepend('\n    <li class="fn__flex menu__item">\n        <img class="avatar avatar--mid" style="width: 24px; height: 24px; margin-right: 10px; background-image: none; background-color: transparent;" src="'+s+'">\n        <div class="fn__flex-1" style="text-align: left !important;">\n            <h2 class="list__user">\n                <a target="_blank" href="'+Label.servePath+"/member/"+o+'" style="color: #c0c0c0; text-decoration: none;">'+l+'</a>\n            </h2>\n            <span class="ft__fade ft__smaller"><a onclick="Util.closeAlert(this);ChatRoom.editor.setValue(\'合议破戒 '+o+'\');ChatRoom.send();$(window).scrollTop(0);" style="cursor: pointer; font-weight: bold;" href="javascript:void(0);">爲他求情</a></span>\n        </div>\n        <div class="fn__flex-center" style="color: #ff1919; font-weight: bold">\n        將於 '+n.getFullYear()+"年"+(n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1)+"月"+n.getDate()+"日 "+n.getHours()+"時"+n.getMinutes()+"分 釋放\n        </div>\n  \n    </li>\n                ")}}})},submitCharacter:function(e){if(0!==linesArray.length){let a=function(e){var t=e.split(","),a=t[0].match(/:(.*?);/)[1],n=atob(t[1]),s=n.length,o=new Uint8Array(s);for(;s--;)o[s]=n.charCodeAt(s);return new Blob([o],{type:a})}(document.getElementById(e).toDataURL());var t=new FormData;t.append("file[]",a),$.ajax({url:Label.servePath+"/upload",type:"POST",cache:!1,data:t,processData:!1,contentType:!1,success:function(e){let t=e.data.succMap.blob;ChatRoom.editor.setValue(ChatRoom.editor.getValue()+"![涂鸦]("+t+")"),ChatRoom.editor.focus(),ChatRoom.clearCharacter("paintCanvas"),$("#paintContent").slideUp(500)},error:function(e){}}),linesArray=[],$(window).scrollTop(0)}else alert("画布为空，无法提交！")},clearCharacter:function(e){var t=document.getElementById(e).getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height),linesArray=[]},revokeChatacter:function(e){linesArray.length>0&&(ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),linesArray.pop(),linesArray.forEach((e=>{ChatRoom.changeColor(e.color),ChatRoom.changeWidth(e.width),ctx.beginPath(),ctx.moveTo(e.point[0].x,e.point[0].y);for(let t=1;t<e.point.length;t++)ctx.lineTo(e.point[t].x,e.point[t].y);ctx.stroke()})))},changeColor:function(e){ctx.fillStyle=ctx.strokeStyle=ctx.shadowColor=e},changeWidth:function(e){ctx.lineWidth=e},charInit:function(e){el=document.getElementById(e),(ctx=el.getContext("2d")).fillStyle=ctx.strokeStyle=ctx.shadowColor="#000",ctx.lineWidth=3,ctx.lineJoin="miter",ctx.lineCap="round",ctx.shadowBlur=2,el.onmousedown=function(e){pointsArray=[],isDrawing=!0,isClick=!0,ctx.beginPath(),x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)},el.onmousemove=function(e){isDrawing&&(isClick=!1,x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke())},el.onmouseup=function(){linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth}),isClick&&(ctx.lineTo(x,y),ctx.stroke()),isDrawing=!1},el.addEventListener("touchstart",(function(e){isClick=!0,pointsArray=[],ctx.beginPath(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)}),!1),el.addEventListener("touchmove",(function(e){isClick=!1,e.preventDefault(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke()}),!1),el.addEventListener("touchend",(function(e){isClick&&(ctx.lineTo(x,y),ctx.stroke()),linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth})}),!1)},setDiscuss:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">修改话题需要16积分，将自动从账户中扣除；<br>最大长度16字符，不合法字符将被自动过滤。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="discuss-new-title">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.updateDiscussData($("#discuss-new-title").val());Util.closeAlert();\'>设置 <span class=\'count\'><svg style=\'vertical-align: -2px;\'><use xlink:href="#iconPoints"></use></svg> 16</span></button>\n</div>\n</div>',"设置话题")},updateDiscussData:function(e){let t={content:"[setdiscuss]"+e+"[/setdiscuss]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),success:function(e){0!==e.code?Util.notice("danger",3e3,e.msg):Util.notice("success",3e3,"话题修改成功，所有人可见。<br>16积分已扣除。")},error:function(e){Util.notice("danger",3e3,e.statusText)}})},useDiscuss:function(){let e=ChatRoom.editor.getValue();ChatRoom.editor.setValue("*`# "+$("#discuss-title").html()+" #`*  "),ChatRoom.editor.insertValue(e,0),ChatRoom.editor.focus()},toggleOnlineAvatar:function(){"none"===$("#chatRoomOnlineCnt").css("display")?($("#chatRoomOnlineCnt").html(Label.onlineAvatarData),setTimeout((function(){$("#toggleAvatarBtn").html('<use xlink:href="#showLess"></use>'),$("#chatRoomOnlineCnt").slideDown(200),setTimeout((function(){Util.listenUserCard()}),200)}),100)):($("#toggleAvatarBtn").html('<use xlink:href="#showMore"></use>'),$("#chatRoomOnlineCnt").slideUp(200))},confirmed:!1,delEmoji:function(e){if(!0===ChatRoom.confirmed||confirm("确定要删除该表情包吗？")){ChatRoom.confirmed=!0;let t=ChatRoom.getEmojis();for(let a=0;a<t.length;a++)t[a]===e&&t.splice(a,1);t.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),ChatRoom.loadEmojis(),setTimeout((function(){$("#emojiBtn").click()}),50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},loadEmojis:function(){let e=ChatRoom.getEmojis(),t="";for(let a=0;a<e.length;a++)t+=`<button onclick="ChatRoom.editor.setValue(ChatRoom.editor.getValue() + '![图片表情](${e[a]})')">\n    <div class="divX"><svg onclick='ChatRoom.delEmoji("${e[a]}");event.cancelBubble =true;' style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg></div>\n    <img style='max-height: 50px' class="vditor-emojis__icon" src="${e[a]}">\n</button>`;$("#emojis").html(t)},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,t){if(ext=t.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var a=new FileReader;a.readAsArrayBuffer(t.files[0]),a.onload=function(e){var a=new Uint8Array(e.target.result.slice(0,11));isImage(a)?e.target.result.byteLength>5242880?Util.alert("图片过大 (最大限制 5M)"):t.submit():Util.alert("只允许上传图片!")}}else t.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){var a={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};ChatRoom.addEmoji(a.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",(function(e){"13"==e.keyCode&&(ChatRoom.addEmoji($("#fromURL").val()),Util.closeAlert())}))},addEmoji:function(){for(let e=0;e<arguments.length;e++){let t=arguments[e],a=ChatRoom.getEmojis();a.reverse();for(let e=0;e<a.length;e++)a[e]===t&&a.splice(e,1);a.push(t),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:a}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),ChatRoom.loadEmojis()},getEmojis:function(){let e;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(t){e=0===t.code&&""!==t.data?Util.parseArray(t.data):[]}}),e.reverse(),e},isSend:!1,send:function(){if(!ChatRoom.isSend){ChatRoom.isSend=!0;var e=ChatRoom.editor.getValue(),t={content:e,client:thisClient};ChatRoom.editor.setValue(""),$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(t){0===t.code?$("#chatContentTip").removeClass("error succ").html(""):($("#chatContentTip").addClass("error").html("<ul><li>"+t.msg+"</li></ul>"),ChatRoom.editor.setValue(e))},error:function(t){$("#chatContentTip").addClass("error").html("<ul><li>"+t.statusText+"</li></ul>"),ChatRoom.editor.setValue(e)},complete:function(e,t){ChatRoom.isSend=!1,$(".form button.red").removeAttr("disabled").css("opacity","1")}})}},more:function(){NProgress.start(),setTimeout((function(){let e;if(page++,1!==page){let t=$(".chats__item"),a=t[t.length-1];e=$(a).attr("id").replace("chatroom","")}Label.hasMore&&(1===page?$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(let t in e.data){let a=e.data[t];0===$("#chatroom"+a.oId).length&&ChatRoom.renderMsg(a,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}}):$.ajax({url:Label.servePath+"/chat-room/getMessage?size=25&mode=1&oId="+e,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(let t in e.data){let a=e.data[t];0===$("#chatroom"+a.oId).length&&ChatRoom.renderMsg(a,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}})),NProgress.done()}),0)},resetMoreBtnListen:function(){$("body").unbind(),$("body").click((function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()})),$("body").click((function(){$("details[open]").removeAttr("open")}))},groupRevokeProcess:!1,startGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.stopGroupRevoke()"),$("#groupRevoke").html("关闭批量撤回"),Util.notice("warning",6e3,"批量撤回已启动，已在消息中添加便捷撤回按钮。<br>使用完成后请记得关闭此功能。"),ChatRoom.groupRevokeProcess=!0;let e=setInterval((function(){ChatRoom.groupRevokeProcess||($("#chats").empty(),page=0,ChatRoom.more(),clearInterval(e)),$(".chats__item").each((function(){0===$(this).find(".button").length&&($(this).find(".date-bar").css("float","left"),$(this).find(".date-bar").html("<button class='button' onclick='ChatRoom.adminRevoke(\""+$(this).attr("id").replace("chatroom","")+"\")'>撤回</button>"))}))}),500)},stopGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.startGroupRevoke()"),$("#groupRevoke").html("批量撤回"),Util.notice("success",1500,"批量撤回已关闭。"),ChatRoom.groupRevokeProcess=!1},adminRevoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code||Util.notice("danger",1500,e.msg)}})},shileds:",",shiled:function(e){confirm("友好的交流是沟通的基础, 确定要屏蔽 Ta 吗？\n本次屏蔽仅针对当前页面有效, 刷新后需重新屏蔽！")&&(ChatRoom.shileds+=e+",")},revoke:function(e){confirm("确定要撤回吗？")&&$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code?Util.notice("success",1500,e.msg):Util.notice("danger",1500,e.msg)}})},repeat:function(e){let t="";$.ajax({url:Label.servePath+"/cr/raw/"+e,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,"")}}),ChatRoom.editor.setValue(t),ChatRoom.send(),$(window).scrollTop(0)},block:function(e){var t=window.localStorage.robot_list?window.localStorage.robot_list:"";t=t&&t.length>0?t+","+e:e,window.localStorage.robot_list=t,catchUsers=t.split(","),Util.notice("success",1e4,"屏蔽 "+e+" 成功，您可以在左侧小机器人图标中找到 TA 发送的消息，也可以在 “修改捕获用户” 中解除对 TA 的屏蔽。")},report:function(e){confirm("确定举报吗？")&&$.ajax({url:Label.servePath+"/report",type:"POST",cache:!1,data:JSON.stringify({reportDataId:e,reportDataType:3,reportType:49,reportMemo:""}),complete:function(e){0===e.responseJSON.code?Util.alert("一键举报成功，感谢你的帮助！<br>管理员将进行审核，如情况属实系统会为举报人发放积分奖励，并对违规者进行相应处罚。"):Util.alert(e.responseJSON.msg)}})},at:function(e,t,a){if(ChatRoom.editor.focus(),!0===a)ChatRoom.editor.insertValue("@"+e+"  \n",!1);else{let a="";$.ajax({url:Label.servePath+"/cr/raw/"+t,method:"get",async:!1,success:function(e){a=e.replace(/(<!--).*/g,""),a=a.replace(/\n/g,"\n> ")}}),ChatRoom.editor.insertValue(`\n##### 引用 @${e} [↩](${Label.servePath}/cr#chatroom${t} "跳转至原消息")  \n> ${a}</span>\n`,!1)}$(window).scrollTop(0)},remarkList:{},remark:function(e,t){let a=prompt(`要给 ${t} 备注什么呢?`);null!==a&&(""===a?delete ChatRoom.remarkList[e]:ChatRoom.remarkList[e]=a,localStorage.setItem("user_remark",JSON.stringify(ChatRoom.remarkList)))},filterContent:function(e,t){let a=document.createElement("div");if(a.innerHTML=e,a.querySelectorAll("img").forEach((e=>{e.setAttribute("originalsrc",e.src),e.src.startsWith("https://file.fishpi.cn")&&(e.src=e.src.split("?")[0]+"?imageView2/0/w/150/h/150/interlace/0/q/90")})),t){let e=a.querySelectorAll("p,h1,h2,h3,h4,h5,h6,h7"),t=/\[color=([^\]]+)\](.*?)\[\/color\]/g;e.forEach((e=>{e.innerHTML=e.innerText.replaceAll(t,'<span style="color:$1">$2</span>')}))}return a.innerHTML},renderRedPacket:function(e,t,a,n,s,o){let i,l,r=!1,c=-1;if(void 0!==s&&(i=s.winnerResult,l=s.diceParticles),t===a)for(let t=0;t<e.length;t++){let a=e[t];a.userMoney>c&&(c=a.userMoney)}for(let t=0;t<e.length;t++){let a=e[t],n=a.userMoney,s=a.dice,o=a.userName;o===Label.currentUser&&(void 0!==n?n>0?$("#redPacketIGot").text("抢到了 "+n+" 积分"):0==n?$("#redPacketIGot").text("恭喜你，抢了个寂寞"):$("#redPacketIGot").text("什么运气，你竟然被反向抢红包了"):void 0!==s&&$("#redPacketIGot").text("押注 "+s.chips+" 积分"),r=!0);let l="";void 0!==s&&(l=s.bet);let d=o;switch(l){case"big":d=o+" (押大)";break;case"small":d=o+" (押小)";break;case"leopard":d=o+" (豹子)"}let h=a.time,u="";void 0!==a.avatar&&(u=`<img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="${a.avatar}">`);let m,p=`<li class="fn__flex menu__item">${u}\n<div class="fn__flex-1" style="text-align: left !important;">\n<h2 class="list__user"><a href="${Label.servePath}/member/${o}">${d}</a>\n</h2>`;n>0&&n===c?(c=-1,p+="<span class='green small btn'>来自老王的认可</span><br>\n"):0===n?p+="<span class='red small btn'>0溢事件</span><br>\n":n<0&&(p+="<span class='yellow small btn'>抢红包有风险</span><br>\n"),void 0!==i&&(i===s.bet?p+="<span class='green small btn'>运气好而已</span><br>\n":p+="<span class='red small btn'>别玩了</span><br>\n"),m=void 0===n&&void 0!==s?s.chips:n,p+=`<span class="ft__fade ft__smaller">${h}</span>\n    </div>\n    <div class="fn__flex-center">${m} 积分</div>\n</li>\n`,$("#redPacketList").append(p)}if(r||$("#redPacketIGot").text(Label.currentUser===o?"金主来了":"你错过了这个红包"),void 0!==n&&n.length>0&&(index=n.indexOf(Label.currentUser),-1===index&&($("#msg").text("这个红包属于 "+n),$("#redPacketIGot").text(Label.currentUser===o?"金主来了":"这个红包不属于你"))),void 0!==i){let e=" ",t=0;for(key in l)t+=l[key];switch(i){case"big":e+=t+"点大";break;case"small":e+=t+"点小";break;case"leopard":e+="豹子通杀"}$("#redPacketIGot").text(l+e)}},bet:function(e){Util.alert('<div class="form fn__flex-column">\n<label id="betRadio">\n  <input type="radio" name="bet" value="big" checked>大\n  <input type="radio" name="bet" value="small">小\n  <input type="radio" name="bet" value="leopard">豹子\n  <div class="ft__smaller ft__fade" style="float: left">筹码</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="100" required="" value="32" id="chipsLabel" name=\'chips\' onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<div class="fn__flex" style="margin-top: 15px">\n  <button class="btn btn--confirm" onclick="ChatRoom.unpackRedPacket('+e+');Util.clearAlert()">押注</button>\n</div>\n</div>',"买定离手"),$("#chipsLabel").on("change",(function(){$("#chipsLabel").val()>100&&$("#chipsLabel").val("100"),$("#chipsLabel").val()<=32&&$("#chipsLabel").val("32")}))},selectGesture:function(e){Util.alert(`<div class="form fn__flex-column select-center">\n<div>\n   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/rock.png" onclick="ChatRoom.unpackRedPacket(${e},'0');Util.clearAlert()"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/scissors.png" onclick="ChatRoom.unpackRedPacket(${e},'1');Util.clearAlert()"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/paper.png" onclick="ChatRoom.unpackRedPacket(${e},'2');Util.clearAlert()"/>\n</div>\n</div>`,"出拳")},unpackRedPacket:function(e,t){null==t&&(t="0"),redPacketMap.set(e,$($("#chatroom"+e).find(".hongbao__item").find("div")[1]).html()),$($("#chatroom"+e).find(".hongbao__item").find("div")[1]).html("红包在路上啦~<br><b>请稍等...</b>"),$("#chatroom"+e).css("pointer-events","none"),$.ajax({url:Label.servePath+"/chat-room/red-packet/open",async:!0,method:"POST",data:JSON.stringify({oId:e,gesture:t,dice:{bet:$("#betRadio>input[name=bet]:checked").val(),chips:$("#betRadio>input[name=chips]").val()}}),success:function(t){if(setTimeout((function(){$($("#chatroom"+e).find(".hongbao__item").find("div")[1]).html(redPacketMap.get(e)),$("#chatroom"+e).css("pointer-events","")}),300),-1!==t.code){let a="抢红包人数较多，加载中...",n="";void 0!==t.info.gesture&&(n=(Label.currentUser===t.info.userName?"你":t.info.userName)+"出拳:  "+["石头","剪刀","布"][t.info.gesture]),Util.alert(`<style>.dialog-header-bg {border-radius: 4px 4px 0 0; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>\n<div class="ft__center">\n    <div class="fn__flex-inline">\n        <img class="avatar avatar--small" src="${t.info.userAvatarURL48}" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0;">\n        <div class="fn__space5"></div>\n        <a href="${Label.servePath}/member/${t.info.userName}">${t.info.userName}</a>'s 红包\n    </div>\n    <div class="fn-hr5"></div>\n${n?`<div class="ft__smaller ft__fade">${n}</div>`:""}    <div id = "msg" class="ft__smaller ft__fade">\n${t.info.msg}\n    </div>\n    <div class="hongbao__count" id='redPacketIGot'>${a}</div>\n    <div class="ft__smaller ft__fade">总计 ${t.info.got}/${t.info.count}</div>\n</div>\n<div class="list"><ul id="redPacketList">\n</ul></div>`,"红包"),ChatRoom.renderRedPacket(t.who,t.info.count,t.info.got,t.recivers,t.diceRet,t.info.userName),t.info.count===t.info.got&&($("#chatroom"+e).find(".hongbao__item").css("opacity",".36").attr("onclick","ChatRoom.unpackRedPacket("+e+")"),$("#chatroom"+e).find(".hongbao__item").hasClass("opened")||$("#chatroom"+e).find(".hongbao__item").addClass("opened"),!0===t.dice?$("#chatroom"+e).find(".redPacketDesc").html("已开盘"):$("#chatroom"+e).find(".redPacketDesc").html("已经被抢光啦"))}else Util.alert(t.msg)},error:function(e){Util.alert(e.msg)}})},plusOne:function(){ChatRoom.editor.setValue(Label.latestMessage),ChatRoom.send()},renderMsg:function(e,t){if(ChatRoom.shileds.indexOf(e.userName)>0)return;let a=e.userName,n=e.content,s=e.md?e.md:"",o=e.userAvatarURL,i=ChatRoom.remarkList[e.userOId];if(!t&&catchUsers.includes(a)&&-1==n.indexOf('"msgType":"redPacket"')&&-1==n.indexOf('"msgType":"music"')&&-1==n.indexOf('"msgType":"weather"')){let t='<div class="robot-msg-item"><div class="avatar" style="background-image: url('+o+')"></div><div class="robot-msg-content"><div class="robot-username"><p>'+a+"</p></div> "+n+' <div class="fn__right" style="margin-top: 5px; font-size: 10px;">'+e.time+"</div></div></div>";ChatRoom.addRobotMsg(t)}else if(!t&&$("#catch-word").prop("checked")&&-1==n.indexOf('"msgType":"redPacket"')&&(s.startsWith("鸽 ")||s.startsWith("小冰 ")||s.startsWith("凌 ")||s.startsWith("ida "))){let t='<div class="robot-msg-item"><div class="avatar" style="background-image: url('+o+')"></div><div class="robot-msg-content"><div class="robot-username"><p>'+a+"</p></div> "+n+' <div class="fn__right" style="margin-top: 5px; font-size: 10px;">'+e.time+"</div></div></div>";ChatRoom.addRobotMsg(t)}else{let a=!1,n=!1,s=!1,o=Label.latestMessage===e.md;try{let t=$.parseJSON(e.content.replace("<p>","").replace("</p>",""));if("redPacket"===t.msgType){a=!0;let n="未知类型红包",s="ChatRoom.unpackRedPacket('"+e.oId+"')";switch(t.type){case"random":n="拼手气红包";break;case"average":n="普通红包";break;case"specify":n="专属红包";break;case"heartbeat":n="心跳红包 (慎抢)";break;case"rockPaperScissors":n="石头剪刀布红包",t.senderId!=Label.currentUserId&&(s="");break;case"dice":if(n="摇骰子",t.senderId!==Label.currentUserId){let a=!1;for(idx in t.who)if(t.who[idx].userId===Label.currentUserId){a=!0;break}a||(s="ChatRoom.bet('"+e.oId+"')")}}if(Number(t.count)===Number(t.got)){let a="已经被抢光啦";"dice"===t.type&&(a="已开盘"),e.content='<div style="opacity: .36;" class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+e.oId+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+t.msg+"<br><b>"+n+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+t.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n'+a+"\n        </div>\n    </div>\n</div>"}else"rockPaperScissors"===t.type&&t.senderId!=Label.currentUserId?e.content='<div class="hongbao__item fn__flex-inline" >\n    <div class="hongbao__finger_guessing">\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+e.oId+',\'0\');"></div>\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+e.oId+',\'1\');"></div>\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+e.oId+',\'2\');"></div>\n    </div>\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+t.msg+"<br><b>"+n+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+t.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>':e.content='<div class="hongbao__item fn__flex-inline" onclick="'+s+'">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+t.msg+"<br><b>"+n+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+t.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>'}else"weather"===t.msgType?(n=!0,e.content='<div id="weather_'+e.oId+'" style="width: 300px;height:280px;" data-date="'+t.date+'" data-code="'+t.weatherCode+'" data-max="'+t.max+'" data-min="'+t.min+'" data-t="'+t.t+'" data-st="'+t.st+'"></div>'):"music"===t.msgType&&(s=!0,e.content='<div class="music-player"><img class="music-player-img" src="'+(""===t.coverURL?Label.servePath+"/images/music/cat.gif":t.coverURL)+'" /><div class="music-player-box"><div class="music-player-title">'+t.title+'</div><div class="music-player-controller"  data-source="'+t.source+'" data-cover="'+t.coverURL+'" data-title="'+t.title+'" data-from="'+t.from+'"><span onclick="ChatRoom.playSound.add(this)">加入列表</span> | <span onclick="ChatRoom.playSound.play(this)">立即播放</span></div></div></div>')}catch(e){}let l="",r="";void 0!==e.userNickname&&""!==e.userNickname?e.userNickname=e.userNickname+" ("+e.userName+")":e.userNickname=e.userName,Label.currentUser===e.userName&&(l=" chats__item--me",r='<a onclick="ChatRoom.revoke('+e.oId+')" class="item">撤回</a>\n'),Label.level3Permitted&&(r='<a onclick="ChatRoom.revoke('+e.oId+')" class="item"><svg><use xlink:href="#administration"></use></svg> 撤回</a>\n');try{let t=e.content.replace("<p>","").replace("</p>",""),a=Util.parseDom(t),n=!1,s="",o=0;for(let e=0;e<a.length;e++){let t=a.item(e);void 0!==t.src&&(n=!0,0!==o&&(s+=","),s+="'"+t.src+"'",o++)}n&&(r+='<a onclick="ChatRoom.addEmoji('+s+')" class="item">一键收藏表情</a>')}catch(e){}let c=[""].includes(e.userOId.toString()),d='<div class="fn-none">';if(d+='<div id="chatroom'+e.oId+'" class="fn__flex chats__item'+l+'">\n    <a href="/member/'+e.userName+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+e.userName+'" style="background-image: url(\''+e.userAvatarURL+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n',d+='<div id="userName" class="ft__fade ft__smaller" style="'+""+'padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="'+(c?"ft-admin-user":"ft-gray")+'">'+(null!=i?i+"-":"")+e.userNickname+"</span>&nbsp;\n",void 0!==e.sysMetal&&""!==e.sysMetal){let t=JSON.parse(e.sysMetal).list;if(void 0!==t)for(let e=0;e<t.length;e++){let a=t[e];d+="<img title='"+a.name+" - "+a.description+"' src='"+Util.genMiniMetal(a.attr)+"'/>"}}if(d+="</div>",d+='        <div class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'" style="margin-top: 3px">\n            '+ChatRoom.filterContent(e.content,c)+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+e.time+'\n                <span class="fn__space5"></span>\n',void 0!==e.client&&""!==e.client){let t=e.client.split("/")[0],a=e.client.split("/")[1];switch(t){case"Web":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-fish"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Bird":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-bird"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Dart":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-dart"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"ElvesOnline":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-moon"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Mobile":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-mobile"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Windows":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-windows"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Linux":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-linux"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"IceNet":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-icenet"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Extension":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-extension"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Edge":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-edge"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Other":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-other"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"PC":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-pc2"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"iOS":case"macOS":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-apple"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Android":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-apk"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Chrome":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-chrome"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"VSCode":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-vscode"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"IDEA":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-idea"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Python":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-python"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Golang":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-golang"></use></svg></span>',d+='<span class="fn__space5"></span>\n';break;case"Harmony":d+='<span class="tooltipped tooltipped-n" aria-label="'+t+" "+a+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-harmony"></use></svg></span>',d+='<span class="fn__space5"></span>\n'}}if(d+=a||n||s?'                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+e.userName+"', '"+e.oId+'\', true)" class="item">@'+e.userName+"</a>\n                        <a onclick=\"ChatRoom.report('"+e.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n                    </details-menu>\n                </details>\n':'                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+e.userName+"', '"+e.oId+'\', true)" class="item">@'+e.userName+"</a>\n                        <a onclick=\"ChatRoom.at('"+e.userName+"', '"+e.oId+'\', false)" class="item">引用</a>\n                        <a onclick="ChatRoom.repeat(\''+e.oId+'\')" class="item">复读机</a>\n                        <a onclick="ChatRoom.remark(\''+e.userOId+"', '"+e.userName+'\')" class="item">备注</a>\n                        <a onclick="ChatRoom.block(\''+e.userName+'\')" class="item">屏蔽该用户发言</a>\n                        <a onclick="ChatRoom.report(\''+e.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n'+r+"                    </details-menu>\n                </details>\n",d+="        </div>\n    </div>\n</div></div>",t){$("#chats").append(d);let e=$("#chats>div.fn-none");e.show(),e.removeClass("fn-none")}else if(o){let e=++Label.plusN;if(1===e){let e="<div id='stacked' class='fn__flex' style='position:relative;display:none;'><span id='plusOne' onclick='ChatRoom.plusOne()' style='display:block;margin-left: 20px'><svg style='width: 30px; height: 20px; cursor: pointer;'><use xlink:href='#plusOneIcon'></use></svg></span></div>";$("#chats").prepend(e);let t=$("#chats>div.latest");$("#stacked").prepend(t),t.find("#userName").show(),t.removeClass("latest")}let t=$("#stacked");1!==e&&t.fadeOut(100),setTimeout((function(){t.append(d),t.height(t.height()+27+"px");let a=$("#stacked>div.fn-none");a.show(),a.css("left",9*e+"px"),a.css("top",27*e+"px"),a.css("position","absolute"),a.find(".chats__content").css("background-color",e%2==0?"rgb(240 245 254)":"rgb(245 245 245)"),a.removeClass("fn-none"),t.fadeIn(200)}),100)}else{$("#plusOne").remove(),e.md&&(Label.latestMessage=e.md,Label.plusN=0);let t=$("#chats");t.find(".latest").removeClass("latest"),t.prepend(d);let a=$("#chats>div.fn-none");a.slideDown(200),a.addClass("latest"),a.removeClass("fn-none")}n&&ChatRoom.initNewWeather(e.oId)}},initNewWeather:function(e){let t,a=document.getElementById("weather_"+e),n=echarts.init(a,null,{renderer:"svg"}),s={CLEAR_DAY:"晴",CLEAR_NIGHT:"晴",PARTLY_CLOUDY_DAY:"多云 ",PARTLY_CLOUDY_NIGHT:"多云",CLOUDY:"阴",LIGHT_HAZE:"轻度雾霾",MODERATE_HAZE:"中度雾霾",HEAVY_HAZE:"重度雾霾",LIGHT_RAIN:"小雨",MODERATE_RAIN:"中雨",HEAVY_RAIN:"大雨",STORM_RAIN:"暴雨",FOG:"雾",LIGHT_SNOW:"小雪",MODERATE_SNOW:"中雪",HEAVY_SNOW:"大雪",STORM_SNOW:"暴雪",DUST:"浮尘",SAND:"沙尘",WIND:"大风"},o={};o.date=a.dataset.date.split(","),o.max=a.dataset.max.split(","),o.min=a.dataset.min.split(","),o.weatherCode=a.dataset.code.split(","),o.weatherName=[],o.t=a.dataset.t,o.st=a.dataset.st;for(var i=0;i<o.weatherCode.length;i++)o.weatherName.push(s[o.weatherCode[i]]);t={title:{text:o.t,subtext:o.st,left:"center",top:"top",textStyle:{fontSize:24},subtextStyle:{fontSize:14}},grid:{show:!0,backgroundColor:"transparent",opacity:.3,borderWidth:"0",top:"200",bottom:"50"},tooltip:{trigger:"axis"},legend:{show:!1},xAxis:[{type:"category",boundaryGap:!1,position:"top",offset:100,zlevel:100,axisLine:{show:!1},axisTick:{show:!1},axisLabel:{interval:0,formatter:["{a|{value}}"].join("\n"),rich:{a:{fontSize:14}}},nameTextStyle:{},data:o.date},{type:"category",boundaryGap:!1,position:"top",offset:20,zlevel:100,axisLine:{show:!1},axisTick:{show:!1},axisLabel:{interval:0,formatter:function(e,t){return"{"+t+"| }\n{b|"+e+"}"},rich:{0:{backgroundColor:{image:Label.servePath+`/images/weather/svg/${o.weatherCode[0]}.svg`},height:40,width:40},1:{backgroundColor:{image:Label.servePath+`/images/weather/svg/${o.weatherCode[1]}.svg`},height:40,width:40},2:{backgroundColor:{image:Label.servePath+`/images/weather/svg/${o.weatherCode[2]}.svg`},height:40,width:40},3:{backgroundColor:{image:Label.servePath+`/images/weather/svg/${o.weatherCode[3]}.svg`},height:40,width:40},4:{backgroundColor:{image:Label.servePath+`/images/weather/svg/${o.weatherCode[4]}.svg`},height:40,width:40},b:{fontSize:12,lineHeight:30,height:20}}},nameTextStyle:{fontWeight:"bold",fontSize:19},data:o.weatherName}],yAxis:{type:"value",show:!1,axisLabel:{formatter:"{value} °C",color:"white"}},series:[{name:"最高气温",type:"line",data:o.max,symbol:"emptyCircle",symbolSize:10,showSymbol:!0,smooth:!0,itemStyle:{normal:{color:"#C95843"}},label:{show:!0,position:"top",formatter:"{c} °C"},lineStyle:{width:1},areaStyle:{opacity:1,color:"transparent"}},{name:"最低气温",type:"line",data:o.min,symbol:"emptyCircle",symbolSize:10,showSymbol:!0,smooth:!0,itemStyle:{normal:{color:"blue"}},label:{show:!0,position:"bottom",formatter:"{c} °C"},lineStyle:{width:1},areaStyle:{opacity:1,color:"transparent"}}]},t&&n.setOption(t)},playSound:{list:[],mode:0,playing:!1,isShow:!1,index:0,ele:null,timer:null,isShowList:!1,isSHowVoice:!1,init(){let e=document.querySelector("#music-core-item"),t=document.querySelector(".music-play-icon"),a=document.querySelector(".music-box"),n=document.querySelector(".music-current"),s=document.querySelector(".music-duration"),o=document.querySelector(".music-title"),i=document.querySelector(".music-img-item");this.ele=e,e.addEventListener("ended",(()=>{this.playing=!1,clearInterval(this.timer),t.src=Label.servePath+"/images/music/circle_play.png",a.classList.remove("playing"),this.autoNext()})),e.addEventListener("play",(()=>{t.src=Label.servePath+"/images/music/circle_pause.png",a.classList.add("playing"),this.timer=setInterval((()=>{n.innerHTML=this.secondsToTime(this.ele.currentTime)}))})),e.addEventListener("pause",(()=>{clearInterval(this.timer),t.src=Label.servePath+"/images/music/circle_play.png",a.classList.remove("playing")})),e.addEventListener("canplay",(()=>{n.innerHTML=this.secondsToTime(this.ele.currentTime),s.innerHTML=this.secondsToTime(this.ele.duration),o.innerHTML=this.list[this.index].title;let e=this.list[this.index].cover;i.src=""===e?Label.servePath+"/images/music/cat.gif":e}))},secondsToTime(e){let t=0,a=0;return(e=parseInt(e))>59?(t=Math.floor(e/60),a=e%60,(t>9?t:"0"+t)+":"+(a>9?a:"0"+a)):(a=e,"00:"+(a>9?a:"0"+a))},toggleMode(){let e=document.querySelector(".music-mode-icon");0===this.mode?(this.mode=1,e.src=Label.servePath+"/images/music/shuffle.png",e.setAttribute("alt","顺序播放")):(this.mode=0,e.src=Label.servePath+"/images/music/repeat.png",e.setAttribute("alt","随机播放"))},add(e,t=!0){let a=e.parentElement.dataset;if(a.source.startsWith("http://music.163.com/song")||a.source.startsWith("https://music.163.com/song")){let e=a.source.split("=");a.source=e[e.length-1]}let n=this.list.findIndex((e=>e.source===a.source));-1===n?(this.list.push(a),this.renderList(),t&&Util.notice("success",2e3,"已加入播放列表。")):this.index=n},remove(e){this.list.splice(e,1),this.renderList(),Util.notice("success",2e3,"已移出播放列表。")},renderList(){let e=document.querySelector(".music-list-box"),t="";for(let e=0;e<this.list.length;e++){let a=this.list[e];t+='<div class="music-list-item">        <img src="'+a.cover+'" alt="">        <div class="music-list-title">'+a.title+'</div>        <div class="music-list-controller">            <span style="color: #198cff" data-i="'+e+'" onclick="ChatRoom.playSound.playIndex('+e+')">播放</span>            <span style="color: red" data-i="'+e+'" onclick="ChatRoom.playSound.remove('+e+')">移除</span>        </div>    </div>'}e.innerHTML=t},next(){0!==this.list.length&&(this.index+=1,this.index>=this.list.length&&(this.index=0),this.playIndex(this.index))},prev(){0!==this.list.length&&(this.index-=1,this.index<0&&(this.index=this.list.length-1),this.playIndex(this.index))},play(e){let t=e.parentElement.dataset;if(this.add(e,!1),t.source.startsWith("http://music.163.com/song")||t.source.startsWith("https://music.163.com/song")){let e=t.source.split("=");t.source=e[e.length-1]}document.querySelector(".music-detail").innerHTML='<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height=86 src="//music.163.com/outchain/player?type=2&id='+t.source+'&auto=1&height=66"></iframe>',this.playing=!1,this.togglePlay(),!this.isShow&&this.show()},playIndex(e){document.querySelector(".music-detail").innerHTML='<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height=86 src="//music.163.com/outchain/player?type=2&id='+this.list[e].source+'&auto=1&height=66"></iframe>',this.playing=!1,this.index=e,this.togglePlay()},autoNext(){0===this.mode?this.next():this.playIndex(Math.floor(Math.random()*this.list.length))},togglePlay(){this.playing=!this.playing},hide(){this.isShow=!1;let e=document.querySelector("#musicBox");document.querySelector(".music-close-icon").src=Label.servePath+"/images/music/arrow_up.png",e.classList.remove("show"),this.isShowList&&this.toggleList()},show(){this.isShow=!0;let e=document.querySelector("#musicBox");document.querySelector(".music-close-icon").src=Label.servePath+"/images/music/arrow_down.png",e.classList.add("show")},toggleShow(){this.isShow?this.hide():this.show()},toggleList(){let e=document.querySelector(".music-list-box");this.isShowList=!this.isShowList,this.isShowList?e.classList.add("show"):e.classList.remove("show")},changeVoice(e){let t=e.value,a=document.querySelector(".music-voice-icon");a.src=t>80?Label.servePath+"/images/music/volume_3.png":t>30?Label.servePath+"/images/music/volume_2.png":t>0?Label.servePath+"/images/music/volume_1.png":Label.servePath+"/images/music/volume_off.png",this.ele.volume=t/100}},imgViewer:null,imgWaitting:!1,imageViewer:function(){if(this.imgViewer&&$("div.vditor-reset.ft__smaller img:not(.ft__smaller,.emoji,.ext-emoji,*[src*='shield'],*[src*='/gen?'])").length===this.imgViewer.length)return;this.imgViewer=this.imgViewer||new Viewer(document.querySelector("#chats"),{inline:!1,className:"PWLimgViwer",filter:e=>!e.parentElement.classList.contains("ft__smaller")&&!e.parentElement.classList.contains("ext-emoji")&&!e.classList.contains("emoji")&&e.src.indexOf("shield")<0&&e.src.indexOf("/gen?")<0,title(){let e=this.images[$(".PWLimgViwer .viewer-active").attr("data-index")];for(;e=e.parentElement,!e.querySelector(".avatar"););return"From @"+e.querySelector(".avatar").getAttribute("aria-label")}});const e=function(){return setTimeout((()=>{ChatRoom.imgViewer.isShown?e():(ChatRoom.imgWaitting=!1,ChatRoom.imgViewer.update())}),1e3),!0};this.imgWaitting=this.imgWaitting||e()},addRobotMsg:function(e,t){$("#robotMsgList").prepend(e);$(".robot-msg-item")&&$(".robot-msg-item").length>50&&$(".robot-msg-item:gt(n-1)").remove()},changeCatchUser:function(e){if(e&&e.length>0){let t='<div class="robot-msg-item"><div class="robot-msg-content">当前捕获用户:'+e+"</div></div></div>";$("#robotMsgList").prepend(t)}else{let e='<div class="robot-msg-item"><div class="robot-msg-content">当前不存在需要捕获的用户</div></div></div>';$("#robotMsgList").prepend(e)}window.localStorage.robot_list=e,catchUsers=e.split(",")},initCatchUser:function(){$("#robotBtn").click((function(){$("#robotBox").show(200),$("#robotBtn").hide(200),setTimeout((()=>{$("#robotBox").addClass("robot-active"),$("#robotBox").attr("style","height:"+(window.innerHeight-25-58)+"px"),$("#robotMsgList").attr("style","height:"+(window.innerHeight-85-58)+"px")}),220)})),$("#robotClose").click((function(){var e=$("#robotBox");setTimeout((()=>{$(".robot-chat-input").val(""),$("#robotBox").hide(200),$("#robotBtn").show(200)}),e.hasClass("robot-active")?420:1),e.removeClass("robot-active"),e.css("height","")})),$("#robotMinimize").click((function(){$("#robotBox").toggleClass("robot-active")})),$("#clearRobotMsg").click((function(){$(".robot-msg-item").remove()})),$("#catch-word").click((function(){window.localStorage["catch-word-flag"]=$("#catch-word").prop("checked")})),$("#changeCatchUsers").click((function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">将捕获的用户id填写到下方输入框；<br>多个用户id的情况用英文逗号隔开。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="robot-catch-user">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.changeCatchUser($("#robot-catch-user").val());Util.closeAlert();\'>确认</button>\n</div>\n</div>',"编辑捕获用户列表"),$("#robot-catch-user").val(window.localStorage.robot_list?window.localStorage.robot_list:"")}));var e=window.localStorage.robot_list?window.localStorage.robot_list:"";ChatRoom.changeCatchUser(e);let t=!1;"true"===window.localStorage["catch-word-flag"]&&(t=!0),$("#catch-word").prop("checked",t)},loadAvatarPendant:function(){let e=(new Date).getFullYear(),t=((new Date).getMonth()+1).toString();t=t[1]?t:"0"+t;let a=(new Date).getDate(),n=`${e}-${t}-${a}`,s={2022:["2022-01-31","2022-02-06"],2023:["2023-01-21","2023-01-27"],2024:["2024-02-09","2024-02-15"],2025:["2025-01-28","2025-02-03"],2026:["2026-02-16","2026-02-22"],2027:["2027-02-06","2027-02-12"]},o={2022:["2022-09-10","2022-09-12"],2023:["2023-09-29","2023-10-01"],2024:["2024-09-17","2024-09-19"],2025:["2025-10-06","2025-10-09"],2026:["2026-09-25","2026-09-27"],2027:["2027-09-15","2027-09-17"]},i=document.querySelector("body");if(10==t&&a<=7)return void i.classList.add("NationalDay");if(12==t&&a>=24&&12==t&&a<=25)return void i.classList.add("Christmas");let l=new Date(n).getTime();new Date(o[e][0]).getTime()<=l&&new Date(o[e][1]).getTime()>=l?i.classList.add("MidAutumnFestival"):new Date(s[e][0]).getTime()<=l&&new Date(s[e][1]).getTime()>=l&&i.classList.add("SpringFestival")},isMobile:function(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],a=!1,n=0;n<t.length;n++)if(e.indexOf(t[n])>0){a=!0;break}var s=window.screen.width,o=window.screen.height;return s>325&&o<750&&(a=!0),a},switchNode:function(){let e='        <h3 style="margin: 0 0 10px; font-size: 18px; color: #333;">请选择区服</h3>        <div style="margin-bottom: 15px;">';Label.node.avaliable.forEach((function(t){e+="<button onclick='ChatRoom.connectNewNode(\""+t.node+"?apiKey="+Label.node.apiKey+'", "'+t.name+'")\' style="background-color: #fff; color: #007bff; border: 1px solid #007bff; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; font-weight: bold;">'+t.name+" "+t.online+"人</button>"})),e+='        </div>        <p style="margin: 0; font-size: 14px; color: #666; line-height: 1.5;">            您切换的区服仅为本次生效，系统会自动将您分配至最流畅的区服。        </p>        <p style="margin: 10px 0 0; font-size: 14px; color: #666; line-height: 1.5;">            所有区服之间消息同步，完全互通。        </p>',Util.alert(e)},connectNewNode:function(e,t){Util.clearAlert(),$("#nodeButton").html("<svg style='vertical-align: -2px;'><use xlink:href=\"#server\"></use></svg> "+t),ChatRoomChannel.ws.close(),ChatRoomChannel.init(e),setTimeout((function(){clearInterval(ChatRoomChannel.manual)}),1e3)}};