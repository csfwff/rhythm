var ChatRoom={init:function(){if(0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!1,position:"bottom"},toolbar:["emoji","headings","bold","italic","|","link","upload","|","undo","redo","|","edit-mode",{name:"more",toolbar:["table","list","ordered-list","check","outdent","indent","quote","code","insert-before","insert-after","fullscreen","both","preview","outline","content-theme","code-theme","devtools","info","help"]}],height:150,placeholder:"说点什么吧！",ctrlEnter:function(){ChatRoom.send()}}),ChatRoom.listenUploadEmojis(),ChatRoom.loadEmojis(),$("#emojiBtn").on("click",function(){$("#emojiList").hasClass("showList")?$("#emojiList").removeClass("showList"):($("#emojiList").addClass("showList"),setTimeout(function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("#emojiList").removeClass("showList"),$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()})})},100))}),$("#redPacketBtn").on("click",function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">红包类型</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="redPacketType">\n  <option value="random" selected>拼手气红包</option>  <option value="average">普通红包</option>  <option value="specify">专属红包</option>  <option value="heartbeat">心跳红包</option>  </select>\n</label>\n<label id = "who" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">发给谁</div>\n  <div class="fn-hr5 fn__5"></div>\n  <div id="recivers" class="chats__users">\n                            </div> \n  <select id="userOption" multiple="multiple" style=\'height: 150px; left: 50px\'>\n  </select>\n  <div id="chatUsernameSelectedPanel" class="completed-panel"\n                             style="height:170px;display:none;left:auto;top:auto;cursor:pointer;"></div> \n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm red" id="xRedPacketConfirm" style=\'margin-right: 10px\'>十连发!</button>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包"),$("#userOption").on("change",function(){var e,t=$("#userOption").val(),a=[];for(index in t)a.push(n.get(t[index]));for(e in $("#recivers").html(""),$("#redPacketCount").val(a.length),a)$("#recivers").append('<a target="_blank" data-name="'+a[e].userName+'"\nhref="'+a[e].homePage+'">\n<img style=\'margin-bottom: 10px\' class="avatar avatar-small" aria-label="'+a[e].userName+'"\nsrc="'+a[e].userAvatarURL+'">\n</a>')});var n=new Map;$("#redPacketType").on("change",function(){"specify"===$("#redPacketType").val()?($("#who").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$.ajax({url:Label.servePath+"/chat-room/online-users",type:"GET",cache:!1,success:function(e){if(0==e.code)for(var t in $("#userOption").html(""),e.data.users){t=e.data.users[t];n.set(t.userName,t),$("#userOption").append('<option value="'+t.userName+'">'+t.userName+"</option>\n")}},error:function(e){}})):($("#who").css("display","none"),$("#redPacketCount").removeAttr("readOnly"))}),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("32"),2e4<$("#redPacketMoney").val()&&$("#redPacketMoney").val("20000"),$("#redPacketMoney").val()<32&&$("#redPacketMoney").val("32"),$("#redPacketAmount").text($("#redPacketMoney").val())}),$("#redPacketMoney,#redPacketCount").bind("input propertychange",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e&&($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！"))}),$("#redPacketType").on("change",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e&&($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！"))}),$("#redPacketCount").on("change",function(){Number($("#redPacketCount").val())>Number($("#redPacketMoney").val())?$("#redPacketCount").val($("#redPacketMoney").val()):(1e3<$("#redPacketCount").val()&&$("#redPacketCount").val("1000"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1"))}),$("#redPacketConfirm").on("click",function(){let e=$("#redPacketType").val();var t=$("#redPacketMoney").val(),a=$("#redPacketCount").val();let n=$("#redPacketMsg").val(),o=$("#userOption").val();""!==e&&null!==e&&void 0!==e||(e="random"),void 0===o&&(o=[]),0==o.length&&"specify"===e&&$("#chatContentTip").addClass("error").html("<ul><li>请选择红包发送对象</li></ul>"),""===n&&(n="摸鱼者，事竟成！");a={type:e,money:t,count:a,msg:n,recivers:o},a={content:"[redpacket]"+JSON.stringify(a)+"[/redpacket]"};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(a),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()}),$("#xRedPacketConfirm").on("click",function(){let e=$("#redPacketType").val();var t=$("#redPacketMoney").val(),a=$("#redPacketCount").val();let n=$("#redPacketMsg").val(),o=$("#userOption").val();""!==e&&null!==e&&void 0!==e||(e="random"),void 0===o&&(o=[]),0==o.length&&"specify"===e&&$("#chatContentTip").addClass("error").html("<ul><li>请选择红包发送对象</li></ul>"),""===n&&(n="摸鱼者，事竟成！");a={type:e,money:t,count:a,msg:n,recivers:o};let s={content:"[redpacket]"+JSON.stringify(a)+"[/redpacket]"};Util.closeAlert();for(let e=1;e<11;e++)setTimeout(function(){$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(s),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}})},500*e)})}),ChatRoom.loadAvatarPendant()},setDiscuss:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">修改话题需要16积分，将自动从账户中扣除；<br>最大长度16字符，不合法字符将被自动过滤。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="discuss-new-title">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.updateDiscussData($("#discuss-new-title").val());Util.closeAlert();\'>设置 <span class=\'count\'><svg style=\'vertical-align: -2px;\'><use xlink:href="#iconPoints"></use></svg> 16</span></button>\n</div>\n</div>',"设置话题")},updateDiscussData:function(e){$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:"[setdiscuss]"+e+"[/setdiscuss]"}),success:function(e){0!==e.code?Util.notice("danger",3e3,e.msg):Util.notice("success",3e3,"话题修改成功，所有人可见。<br>16积分已扣除。")},error:function(e){Util.notice("danger",3e3,e.statusText)}})},useDiscuss:function(){var e=ChatRoom.editor.getValue();ChatRoom.editor.setValue("*`# "+$("#discuss-title").html()+" #`*  "),ChatRoom.editor.insertValue(e,0),ChatRoom.editor.focus()},toggleOnlineAvatar:function(){"none"===$("#chatRoomOnlineCnt").css("display")?($("#chatRoomOnlineCnt").html(Label.onlineAvatarData),setTimeout(function(){$("#toggleAvatarBtn").html('<use xlink:href="#showLess"></use>'),$("#chatRoomOnlineCnt").slideDown(200),setTimeout(function(){Util.listenUserCard()},200)},100)):($("#toggleAvatarBtn").html('<use xlink:href="#showMore"></use>'),$("#chatRoomOnlineCnt").slideUp(200))},confirmed:!1,delEmoji:function(a){if(!0===ChatRoom.confirmed||confirm("确定要删除该表情包吗？")){ChatRoom.confirmed=!0;let t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),ChatRoom.loadEmojis(),setTimeout(function(){$("#emojiBtn").click()},50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},loadEmojis:function(){$("#emojis").html("");var t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)$("#emojis").append('<button>\n    <div class="divX" onclick=\'ChatRoom.delEmoji("'+t[e]+'")\'>\n        <svg style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg>\n    </div>    <img style=\'max-height: 50px\' onclick="ChatRoom.editor.setValue(ChatRoom.editor.getValue() + \'![图片表情]('+t[e]+')\')" class="vditor-emojis__icon" src="'+t[e]+'">\n</button>')},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){var t;ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob?((t=new FileReader).readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?5242880<e.target.result.byteLength?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}):a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){t={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};ChatRoom.addEmoji(t.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",function(e){"13"==e.keyCode&&(ChatRoom.addEmoji($("#fromURL").val()),Util.closeAlert())})},addEmoji:function(){for(let e=0;e<arguments.length;e++){var a=arguments[e];let t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.push(a),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),ChatRoom.loadEmojis()},getEmojis:function(){let t;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){t=0===e.code&&""!==e.data?Util.parseArray(e.data):[]}}),t},isSend:!1,send:function(){var e;ChatRoom.isSend||(ChatRoom.isSend=!0,e=ChatRoom.editor.getValue(),$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:e}),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue("")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,t){ChatRoom.isSend=!1,$(".form button.red").removeAttr("disabled").css("opacity","1")}}))},more:function(){NProgress.start(),setTimeout(function(){page++,Label.hasMore&&$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t];0===$("#chatroom"+t.oId).length&&ChatRoom.renderMsg(t,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}}),NProgress.done()},0)},resetMoreBtnListen:function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("details[open]").removeAttr("open")})},groupRevokeProcess:!1,startGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.stopGroupRevoke()"),$("#groupRevoke").html('<svg style="vertical-align: -2px;"><use xlink:href="#administration"></use></svg>\n关闭批量撤回'),Util.notice("warning",6e3,"批量撤回已启动，已在消息中添加便捷撤回按钮。<br>使用完成后请记得关闭此功能。"),ChatRoom.groupRevokeProcess=!0;let e=setInterval(function(){ChatRoom.groupRevokeProcess||($("#chats").empty(),page=0,ChatRoom.more(),clearInterval(e)),$(".chats__item").each(function(){0===$(this).find(".button").length&&($(this).find(".date-bar").css("float","left"),$(this).find(".date-bar").html("<button class='button' onclick='ChatRoom.adminRevoke(\""+$(this).attr("id").replace("chatroom","")+"\")'>撤回</button>"))})},500)},stopGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.startGroupRevoke()"),$("#groupRevoke").html('<svg style="vertical-align: -2px;"><use xlink:href="#administration"></use></svg>\n批量撤回'),Util.notice("success",1500,"批量撤回已关闭。"),ChatRoom.groupRevokeProcess=!1},adminRevoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code||Util.notice("danger",1500,e.msg)}})},revoke:function(e){confirm("确定要撤回吗？")&&$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code?Util.notice("success",1500,e.msg):Util.notice("danger",1500,e.msg)}})},repeat:function(e){let t="";$.ajax({url:Label.servePath+"/cr/raw/"+e,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,"")}}),ChatRoom.editor.setValue(t),ChatRoom.send(),$(window).scrollTop(0)},at:function(e,a,t){if(ChatRoom.editor.focus(),!0===t)ChatRoom.editor.insertValue("@"+e+"  \n",!1);else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}}),ChatRoom.editor.insertValue("\n##### 引用 @"+e+"  \n> "+t+"\n",!1)}$(window).scrollTop(0)},renderRedPacket:function(n,e,t,a){let o=!1,s=-1;if(e===t)for(let e=0;e<n.length;e++){var i=n[e];i.userMoney>s&&(s=i.userMoney)}for(let a=0;a<n.length;a++){var l=n[a],r=l.userMoney,c=l.userName;c===Label.currentUser&&(0<r?$("#redPacketIGot").text("抢到了 "+r+" 积分"):0==r?$("#redPacketIGot").text("恭喜你，抢了个寂寞"):$("#redPacketIGot").text("什么运气，你竟然被反向抢红包了"),o=!0);var d=l.time;let e="";void 0!==l.avatar&&(e='<img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="'+l.avatar+'">\n');let t='<li class="fn__flex menu__item">\n'+e+'    <div class="fn__flex-1" style="text-align: left !important;">\n        <h2 class="list__user"><a href="'+Label.servePath+"/member/"+c+'">'+c+"</a></h2>\n";0<r&&r===s?(s=-1,t+="<span class='green small btn'>来自老王的认可</span><br>\n"):0===r?t+="<span class='red small btn'>0溢事件</span><br>\n":r<0&&(t+="<span class='yellow small btn'>抢红包有风险</span><br>\n"),t+='<span class="ft__fade ft__smaller">'+d+'</span>\n    </div>\n    <div class="fn__flex-center">'+r+" 积分</div>\n</li>\n",$("#redPacketList").append(t)}o||$("#redPacketIGot").text("你错过了这个红包"),void 0!==a&&0<a.length&&(index=a.indexOf(Label.currentUser),-1===index&&($("#msg").text("这个红包属于 "+a),$("#redPacketIGot").text("这个红包不属于你")))},unpackRedPacket:function(t){$.ajax({url:Label.servePath+"/chat-room/red-packet/open",method:"POST",data:JSON.stringify({oId:t}),success:function(e){-1!==e.code?(Util.alert('<style>.dialog-header-bg {border-radius: 4px 4px 0px 0px; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="ft__center">\n    <div class="fn__flex-inline">\n        <img class="avatar avatar--small" src="'+e.info.userAvatarURL+'" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0px;">\n        <div class="fn__space5"></div>\n        <a href="'+Label.servePath+"/member/"+e.info.userName+'">'+e.info.userName+'</a>\'s 红包\n    </div>\n    <div class="fn-hr5"></div>\n    <div id = "msg" class="ft__smaller ft__fade">\n'+e.info.msg+'\n    </div>\n    <div class="hongbao__count" id=\'redPacketIGot\'>\n抢红包人数较多，加载中...    </div>\n    <div class="ft__smaller ft__fade">总计 '+e.info.got+"/"+e.info.count+'</div>\n</div>\n<div class="list"><ul id="redPacketList">\n</ul></div>',"红包"),ChatRoom.renderRedPacket(e.who,e.info.count,e.info.got,e.recivers),e.info.count===e.info.got&&($("#chatroom"+t).find(".hongbao__item").css("opacity",".36"),$("#chatroom"+t).find(".redPacketDesc").html("已经被抢光啦"))):Util.alert(e.msg)},error:function(e){Util.alert(e.msg)}})},plusOne:function(){ChatRoom.editor.setValue(Label.latestMessage),ChatRoom.send()},renderMsg:function(s,e){let t=!1;var a=Label.latestMessage===s.md;try{var n=$.parseJSON(s.content.replace("<p>","").replace("</p>",""));if("redPacket"===n.msgType){t=!0;let e="未知类型红包";switch(n.type){case"random":e="拼手气红包";break;case"average":e="普通红包";break;case"specify":e="专属红包";break;case"heartbeat":e="心跳红包 (慎抢)"}Number(n.count)===Number(n.got)?s.content='<div style="opacity: .36;" class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+s.oId+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+n.msg+"<br><b>"+e+'</b></div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n           已经被抢光啦\n        </div>\n    </div>\n</div>':s.content='<div class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+s.oId+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+n.msg+"<br><b>"+e+'</b></div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>'}}catch(e){}let o="",i="";void 0!==s.userNickname&&""!==s.userNickname?s.userNickname=s.userNickname+" ("+s.userName+")":s.userNickname=s.userName,Label.currentUser===s.userName&&(o=" chats__item--me",i='<a onclick="ChatRoom.revoke('+s.oId+')" class="item">撤回</a>\n'),Label.level3Permitted&&(i='<a onclick="ChatRoom.revoke('+s.oId+')" class="item"><svg><use xlink:href="#administration"></use></svg> 撤回</a>\n');try{var l=s.content.replace("<p>","").replace("</p>","");let t=Util.parseDom(l),a=!1,n="",o=0;for(let e=0;e<t.length;e++){var r=t.item(e);void 0!==r.src&&(a=!0,0!==o&&(n+=","),n+="'"+r.src+"'",o++)}a&&(i+='<a onclick="ChatRoom.addEmoji('+n+')" class="item">一键收藏表情</a>')}catch(e){}let c='<div class="fn-none">';c+='<div id="chatroom'+s.oId+'" class="fn__flex chats__item'+o+'">\n    <a href="/member/'+s.userName+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+s.userName+'" style="background-image: url(\''+s.userAvatarURL+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n';l=Label.currentUser!==s.userName||a?"":"display: none;";if(c+='<div id="userName" class="ft__fade ft__smaller" style="'+l+'padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+s.userNickname+"</span>\n",void 0!==s.sysMetal&&""!==s.sysMetal){var d=JSON.parse(s.sysMetal).list;if(void 0!==d)for(let e=0;e<d.length;e++){var u=d[e];c+="<img title='"+u.description+"' src='"+Util.genMetal(u.name,u.attr)+"'/>"}}if(c+="</div>",c+='        <div style="margin-top: 4px" class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'">\n            '+s.content+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+s.time+'\n                <span class="fn__space5"></span>\n',t||(c+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+s.userName+"', '"+s.oId+'\', true)" class="item">@'+s.userName+"</a>\n                        <a onclick=\"ChatRoom.at('"+s.userName+"', '"+s.oId+'\', false)" class="item">引用</a>\n                        <a onclick="ChatRoom.repeat(\''+s.oId+'\')" class="item">复读机</a>\n'+i+"                    </details-menu>\n                </details>\n"),c+="        </div>\n    </div>\n</div></div>",e){$("#chats").append(c);let e=$("#chats>div.fn-none");e.show(),e.removeClass("fn-none")}else if(a){let t=++Label.plusN;if(1==t){$("#chats").prepend("<div id='stacked' class='fn__flex' style='position:relative;display:none;'><span id='plusOne' onclick='ChatRoom.plusOne()' style='display:block;margin-left: 20px'><svg style='width: 30px; height: 20px; cursor: pointer;'><use xlink:href='#plusOneIcon'></use></svg></span></div>");let e=$("#chats>div.latest");$("#stacked").prepend(e),e.find("#userName").show(),e.removeClass("latest")}let a=$("#stacked");1!=t&&a.fadeOut(100),setTimeout(function(){a.append(c),a.height(a.height()+27+"px");let e=$("#stacked>div.fn-none");e.show(),e.css("left",9*t+"px"),e.css("top",27*t+"px"),e.css("position","absolute"),e.find(".chats__content").css("background-color",t%2==0?"rgb(240 245 254)":"rgb(245 245 245)"),e.removeClass("fn-none"),a.fadeIn(200)},100)}else{$("#plusOne").remove(),s.md&&(Label.latestMessage=s.md,Label.plusN=0);let e=$("#chats");e.find(".latest").removeClass("latest"),e.prepend(c);let t=$("#chats>div.fn-none");t.slideDown(200),t.addClass("latest"),t.removeClass("fn-none")}},imgViewer:null,imgWaitting:!1,imageViewer:function(){if(!this.imgViewer||$("div.vditor-reset.ft__smaller img:not(.ft__smaller,.emoji)").length!==this.imgViewer.length){this.imgViewer=this.imgViewer||new Viewer(document.querySelector("#chats"),{inline:!1,className:"PWLimgViwer",filter:e=>!e.parentElement.classList.contains("ft__smaller")&&!e.classList.contains("emoji"),title(){let e=this.images[$(".PWLimgViwer .viewer-active").attr("data-index")];for(;e=e.parentElement,!e.querySelector(".avatar"););return"From @"+e.querySelector(".avatar").getAttribute("aria-label")}});const e=function(){return setTimeout(()=>{ChatRoom.imgViewer.isShown?e():(ChatRoom.imgWaitting=!1,ChatRoom.imgViewer.update())},1e3),!0};this.imgWaitting=this.imgWaitting||e()}},loadAvatarPendant:function(){var e=(new Date).getFullYear(),t=(new Date).getMonth()+1,a=(new Date).getDate(),n=e+`-${t}-`+a,o={2021:["2021-02-11","2021-02-17"],2022:["2022-01-31","2022-02-06"],2023:["2023-01-21","2023-01-07"],2024:["2024-02-09","2024-02-15"],2025:["2025-01-28","2025-02-03"],2026:["2026-02-16","2026-01-22"]},s={2021:["2021-09-19","2021-09-21"],2022:["2022-09-10","2022-09-12"],2023:["2023-09-29","2023-10-01"],2024:["2024-09-17","2024-09-19"],2025:["2025-10-06","2025-10-09"],2026:["2026-09-25","2026-09-27"]};let i=document.querySelector("body");10===t&&a<=7?i.classList.add("NationalDay"):12===t&&24<=a&&12===t&&a<=25?i.classList.add("Christmas"):new Date(s[e][0])<=new Date(n)&&new Date(s[e][1])>=new Date(n)?i.classList.add("MidAutumnFestival"):new Date(o[e][0])<=new Date(n)&&new Date(o[e][1])>=new Date(n)&&i.classList.add("SpringFestival")}};