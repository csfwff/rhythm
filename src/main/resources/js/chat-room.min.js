var ChatRoom={init:function(){if(0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","link","|","list","ordered-list","check","outdent","indent","|","quote","code","insert-before","insert-after","|","upload","table","|","undo","redo","|",{name:"more",toolbar:["fullscreen","edit-mode","both","preview","outline","content-theme","code-theme","devtools","info","help"]}],height:200,counter:40960,placeholder:"聊天室历史记录将永久保存，每天一次撤回机会；在发送消息前请三思而后行，友善是第一原则。",ctrlEnter:function(){ChatRoom.send()}}),$(".chat-room").on("click",".vditor-reset img",function(){$(this).hasClass("emoji")||window.open($(this).attr("src"))}),ChatRoom.listenUploadEmojis(),ChatRoom.loadEmojis(),$("#emojiBtn").on("click",function(){$("#emojiList").hasClass("showList")?$("#emojiList").removeClass("showList"):($("#emojiList").addClass("showList"),setTimeout(function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("#emojiList").removeClass("showList"),$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()})})},100))}),$("#redPacketBtn").on("click",function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm red" id="xRedPacketConfirm" style=\'margin-right: 10px\'>十连发!</button>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包"),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("32"),2e4<$("#redPacketMoney").val()&&$("#redPacketMoney").val("20000"),$("#redPacketMoney").val()<32&&$("#redPacketMoney").val("32"),$("#redPacketAmount").text($("#redPacketMoney").val())}),$("#redPacketCount").on("change",function(){Number($("#redPacketCount").val())>Number($("#redPacketMoney").val())?$("#redPacketCount").val($("#redPacketMoney").val()):(1e3<$("#redPacketCount").val()&&$("#redPacketCount").val("1000"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1"))}),$("#redPacketConfirm").on("click",function(){var e=$("#redPacketMoney").val(),t=$("#redPacketCount").val();let a=$("#redPacketMsg").val();""===a&&(a="摸鱼者，事竟成！");t={money:e,count:t,msg:a},t={content:"[redpacket]"+JSON.stringify(t)+"[/redpacket]"};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()}),$("#xRedPacketConfirm").on("click",function(){var e=$("#redPacketMoney").val(),t=$("#redPacketCount").val();let a=$("#redPacketMsg").val();""===a&&(a="摸鱼者，事竟成！");t={money:e,count:t,msg:a};let n={content:"[redpacket]"+JSON.stringify(t)+"[/redpacket]"};Util.closeAlert();for(let e=1;e<11;e++)setTimeout(function(){$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(n),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}})},500*e)})})},delEmoji:function(t){let a=ChatRoom.getEmojis();for(let e=0;e<a.length;e++)a[e]===t&&a.splice(e,1);$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:a}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),ChatRoom.loadEmojis(),setTimeout(function(){$("#emojiBtn").click()},50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})},loadEmojis:function(){$("#emojis").html("");var t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)$("#emojis").append('<button>\n    <div class="divX" onclick=\'ChatRoom.delEmoji("'+t[e]+'")\'>\n        <svg style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg>\n    </div>    <img style=\'max-height: 50px\' onclick="ChatRoom.editor.setValue(ChatRoom.editor.getValue() + \'![图片表情]('+t[e]+')\')" class="vditor-emojis__icon" src="'+t[e]+'">\n</button>')},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){var t;ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob?((t=new FileReader).readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?5242880<e.target.result.byteLength?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}):a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){t={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};ChatRoom.addEmoji(t.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",function(e){"13"==e.keyCode&&(ChatRoom.addEmoji($("#fromURL").val()),Util.closeAlert())})},addEmoji:function(){for(let e=0;e<arguments.length;e++){var a=arguments[e];let t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.push(a),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),ChatRoom.loadEmojis()},getEmojis:function(){let t;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){t=0===e.code&&""!==e.data?Util.parseArray(e.data):[]}}),t},send:function(){var e=ChatRoom.editor.getValue();$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:e}),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue("")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,t){$(".form button.red").removeAttr("disabled").css("opacity","1")}})},more:function(){NProgress.start(),setTimeout(function(){page++,$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t],t=ChatRoom.renderMessage(t.userNickname,t.userName,t.userAvatarURL,t.time,t.content,t.oId,Label.currentUser,Label.level3Permitted);$("#chats").append(t),$("#chats>div.fn-none").show(),$("#chats>div.fn-none").removeClass("fn-none"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard()}else alert("没有更多聊天消息了！")}}),NProgress.done()},0)},resetMoreBtnListen:function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("details[open]").removeAttr("open")})},groupRevokeProcess:!1,startGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.stopGroupRevoke()"),$("#groupRevoke").html('<svg><use xlink:href="#userrole"></use></svg>\n关闭批量撤回'),Util.notice("warning",6e3,"批量撤回已启动，已在消息中添加便捷撤回按钮。<br>使用完成后请记得关闭此功能。"),ChatRoom.groupRevokeProcess=!0;let e=setInterval(function(){ChatRoom.groupRevokeProcess||($("#chats").empty(),page=0,ChatRoom.more(),clearInterval(e)),$(".chats__item").each(function(){0===$(this).find(".button").length&&($(this).find(".date-bar").css("float","left"),$(this).find(".date-bar").html("<button class='button' onclick='ChatRoom.adminRevoke(\""+$(this).attr("id").replace("chatroom","")+"\")'>撤回</button>"))})},500)},stopGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.startGroupRevoke()"),$("#groupRevoke").html('<svg><use xlink:href="#userrole"></use></svg>\n批量撤回'),Util.notice("success",1500,"批量撤回已关闭。"),ChatRoom.groupRevokeProcess=!1},adminRevoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code||Util.notice("danger",1500,e.msg)}})},revoke:function(e){confirm("确定要撤回吗？")&&$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code?Util.notice("success",1500,e.msg):Util.notice("danger",1500,e.msg)}})},at:function(e,a,t){if(!0===t){t=ChatRoom.editor.getValue();"\n"!==t?ChatRoom.editor.setValue("@"+e+"  : "+t):ChatRoom.editor.setValue("@"+e+"  : ")}else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}});a=ChatRoom.editor.getValue();"\n"!==a?ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说："+a):ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说：")}ChatRoom.editor.focus()},renderRedPacket:function(n,e,t){let o=!1,s=-1;if(e===t)for(let e=0;e<n.length;e++){var a=n[e];a.userMoney>s&&(s=a.userMoney)}for(let a=0;a<n.length;a++){var i=n[a],r=i.userMoney,l=i.userName;l===Label.currentUser&&(0<r?$("#redPacketIGot").text("抢到了 "+r+" 积分"):0==r?$("#redPacketIGot").text("恭喜你，抢了个寂寞"):$("#redPacketIGot").text("什么运气，你竟然被反向抢红包了"),o=!0);var c=i.time;let e="";void 0!==i.avatar&&(e='<img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="'+i.avatar+'">\n');let t='<li class="fn__flex menu__item">\n'+e+'    <div class="fn__flex-1" style="text-align: left !important;">\n        <h2 class="list__user"><a href="'+Label.servePath+"/member/"+l+'">'+l+"</a></h2>\n";r===s?(s=-1,t+="<span class='green small btn'>来自老王的认可</span><br>\n"):0===r?t+="<span class='red small btn'>0溢事件</span><br>\n":r<0&&(t+="<span class='yellow small btn'>抢红包有风险</span><br>\n"),t+='<span class="ft__fade ft__smaller">'+c+'</span>\n    </div>\n    <div class="fn__flex-center">'+r+" 积分</div>\n</li>\n",$("#redPacketList").append(t)}o||$("#redPacketIGot").text("你错过了这个红包")},unpackRedPacket:function(t){$.ajax({url:Label.servePath+"/chat-room/red-packet/open",method:"POST",data:JSON.stringify({oId:t}),success:function(e){Util.alert('<style>.dialog-header-bg {border-radius: 4px 4px 0px 0px; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="ft__center">\n    <div class="fn__flex-inline">\n        <img class="avatar avatar--small" src="'+e.info.userAvatarURL+'" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0px;">\n        <div class="fn__space5"></div>\n        <a href="'+Label.servePath+"/member/"+e.info.userName+'">'+e.info.userName+'</a>\'s 红包\n    </div>\n    <div class="fn-hr5"></div>\n    <div class="ft__smaller ft__fade">\n'+e.info.msg+'\n    </div>\n    <div class="hongbao__count" id=\'redPacketIGot\'>\n抢红包人数较多，加载中...    </div>\n    <div class="ft__smaller ft__fade">总计 '+e.info.got+"/"+e.info.count+'</div>\n</div>\n<div class="list"><ul id="redPacketList">\n</ul></div>',"红包"),ChatRoom.renderRedPacket(e.who,e.info.count,e.info.got),e.info.count===e.info.got&&($("#chatroom"+t).find(".hongbao__item").css("opacity",".36"),$("#chatroom"+t).find(".redPacketDesc").html("已经被抢光啦"))},error:function(e){Util.alert(e.msg)}})},plusOne:function(){ChatRoom.editor.setValue(Label.latestMessage),ChatRoom.send()},renderMessage:function(e,t,a,n,s,o,i,r,l){let c=!1;try{var d=$.parseJSON(s.replace("<p>","").replace("</p>",""));"redPacket"===d.msgType&&(c=!0,s=Number(d.count)===Number(d.got)?'<div style="opacity: .36;" class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+o+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+d.msg+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n           已经被抢光啦\n        </div>\n    </div>\n</div>':'<div class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+o+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+d.msg+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>')}catch(e){}try{!0===l&&(s+="<span id='plusOne' onclick='ChatRoom.plusOne()'><svg style='width: 20px; height: 20px; cursor: pointer;'><use xlink:href='#plusOneIcon'></use></svg></span>")}catch(e){}let u="",m="";e=void 0!==e&&""!==e?e+" ("+t+")":t,i===t&&(u=" chats__item--me",m='<a onclick="ChatRoom.revoke('+o+')" class="item">撤回</a>\n'),r&&(m='<a onclick="ChatRoom.revoke('+o+')" class="item"><svg><use xlink:href="#userrole"></use></svg> 撤回</a>\n');try{var f=s.replace("<p>","").replace("</p>","");let t=Util.parseDom(f),a=!1,n="",o=0;for(let e=0;e<t.length;e++){var h=t.item(e);void 0!==h.src&&(a=!0,0!==o&&(n+=","),n+="'"+h.src+"'",o++)}a&&(m+='<a onclick="ChatRoom.addEmoji('+n+')" class="item">一键收藏表情</a>')}catch(e){}let v='<div class="fn-none">';return v+='<div id="chatroom'+o+'" class="fn__flex chats__item'+u+'">\n    <a href="/member/'+t+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+t+'" style="background-image: url(\''+a+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n',i!==t&&(v+='<div class="ft__fade ft__smaller" style="padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+e+"</span>\n</div>"),v+='        <div style="margin-top: 4px" class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+'\n                <span class="fn__space5"></span>\n',c||(v+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+t+"', '"+o+'\', true)" class="item">@'+t+"</a>\n                        <a onclick=\"ChatRoom.at('"+t+"', '"+o+'\', false)" class="item">引用</a>\n'+m+"                    </details-menu>\n                </details>\n"),v+="        </div>\n    </div>\n</div></div>",v}};