var el,ctx,isDrawing=!1,x=0,y=0,isClick=!0,thisClient="Web/PC网页端",BarragerColorPicker=null,DarwColorPicker=null,redPacketMap=new Map,catchUserParam=window.localStorage.robot_list||"",catchUsers=0<catchUserParam.length?catchUserParam.split(","):[],catchWordFlag=1==window.localStorage["catch-word-flag"]||"true"==window.localStorage["catch-word-flag"],ChatRoom=($("#catch-word").prop("checked",catchWordFlag),{init:function(){if(ChatRoom.isMobile()&&(thisClient="Mobile/移动网页端"),0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","|","link","upload","|","undo","redo","|","edit-mode","fullscreen",{name:"more",toolbar:["table","list","ordered-list","check","outdent","indent","quote","code","insert-before","insert-after","info","help"]}],height:150,placeholder:"说点什么吧！",ctrlEnter:function(){ChatRoom.send()}}),ChatRoom.listenUploadEmojis(),ChatRoom.loadEmojis();{let t=(new Date).getTime(),a=0;function e(){0!==a&&(clearTimeout(a),a=0),t=(new Date).getTime(),a=setTimeout(()=>{(new Date).getTime()-t<=700&&$("#emojiList").removeClass("showList")},null!==navigator.userAgent.match(/(phone|pad|pod|ios|Android|Mobile|BlackBerry|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian)/i)?0:600)}$("#emojiBtn").hover(function(e){$("#emojiList").css("top","290px"),0!==a&&(clearTimeout(a),a=0),t=(new Date).getTime(),setTimeout(()=>0!==$("#emojiBtn:hover").length&&$("#emojiList").addClass("showList"),300)},e),$("#emojiList").hover(function(){0!==a&&(clearTimeout(a),a=0),t=(new Date).getTime()},e)}$("#redPacketBtn").on("click",function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">红包类型</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="redPacketType">\n  <option value="random" selected>拼手气红包</option>  <option value="average">普通红包</option>  <option value="specify">专属红包</option>  <option value="heartbeat">心跳红包</option>  <option value="rockPaperScissors">猜拳红包</option>  </select>\n</label>\n<label id="gesture" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">出拳</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="gestureType">\n  <option value="0" selected>石头</option>  <option value="1">剪刀</option>  <option value="2">布</option>  </select>\n</label>\n<label id = "who" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">发给谁</div>\n  <div class="fn-hr5 fn__5"></div>\n  <div id="recivers" class="chats__users">\n                            </div> \n  <input id="userInput" type=\'text\' autocomplete=\'off\'> \n  <div class=\'selected-username-box\'><div id="chatUsernameSelectedPanel" class="selected-username-panel"\n                             style="height:170px;"></div><div class=\'arrow_up\'></div></div> \n</label>\n<label id=\'redPacketMoneyLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label id=\'redPacketCountLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left" id="countx">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div id=\'totalAmount\' class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包");var l=[],e=0,s=($("#userInput").on("focus input",function(){var a=$("#userInput").val().toUpperCase(),n=(clearTimeout(e),$(".selected-username-box").hide(),$("#chatUsernameSelectedPanel").html(""),"");s.forEach((e,t)=>{t.toUpperCase().includes(a)&&(n+=`<div class="candidateName">${t}</div>`)}),$("#chatUsernameSelectedPanel").html(n),$(".selected-username-box").show(),$(".candidateName").on("click",function(){var e=$(this).html();if(console.log(l.includes(e)),!l.includes(e)){l.push(e);var t,a=[];for(index in l)a.push(s.get(l[index]));for(t in $("#recivers").html(""),$("#redPacketCount").val(a.length),a)$("#recivers").append('<a target="_blank" data-name="'+a[t].userName+'"\nhref="'+a[t].homePage+'">\n<img style=\'margin-bottom: 10px\' class="avatar avatar-small" aria-label="'+a[t].userName+'"\nsrc="'+a[t].userAvatarURL+'">\n</a>')}})}),$("#userInput").on("blur",function(){e=setTimeout(()=>{$(".selected-username-box").hide()},500)}),new Map);$("#redPacketType").on("change",function(){var e=$("#redPacketType").val();"specify"===e?($("#who").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$.ajax({url:Label.servePath+"/chat-room/online-users",type:"GET",cache:!1,success:function(e){if(0==e.code)for(var t in $("#userOption").html(""),e.data.users){t=e.data.users[t];s.set(t.userName,t)}},error:function(e){}})):($("#who").css("display","none"),$("#gesture").css("display","none"),$("#redPacketCount").removeAttr("readOnly"),$("#redPacketMoneyLabel").removeAttr("style"),$("#totalAmount").css("display","inline"),$("#countx").text("个数"),$("#redPacketCount").val("1")),"heartbeat"===e&&($("#countx").text("个数（最少5个）"),$("#redPacketCount").val("5")),"rockPaperScissors"===e&&($("#gesture").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")),"dice"===e&&($("#redPacketMoneyLabel").css("display","none"),$("#totalAmount").css("display","none"),$("#countx").text("开盘人数"),$("#redPacketCount").val("3"))}),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("32"),$("#redPacketMoney").val()<32&&$("#redPacketMoney").val("32"),$("#redPacketAmount").text($("#redPacketMoney").val()),"rockPaperScissors"===$("#redPacketType").val()&&$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")}),$("#redPacketMoney,#redPacketCount").bind("input propertychange",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e&&$("#redPacketAmount").text($("#redPacketMoney").val()+" (含猜拳红包税 5%，实际红包 "+Math.floor(.95*$("#redPacketMoney").val())+" 积分) ")}),$("#redPacketType").on("change",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e?$("#redPacketMsg").val("石头剪刀布！"):"dice"===e&&$("#redPacketMsg").val("买定离手！")}),$("#redPacketCount").on("change",function(){var e=$("#redPacketType").val();"dice"===e&&(15<$("#redPacketCount").val()&&$("#redPacketCount").val("15"),$("#redPacketCount").val()<3)&&$("#redPacketCount").val("3"),"heartbeat"===e&&$("#redPacketCount").val()<5&&$("#redPacketCount").val("5"),Number($("#redPacketCount").val())>Number($("#redPacketMoney").val())?$("#redPacketCount").val($("#redPacketMoney").val()):(100<$("#redPacketCount").val()&&$("#redPacketCount").val("100"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1"))}),$("#redPacketConfirm").on("click",function(){let e=$("#redPacketType").val();var t=$("#redPacketMoney").val(),a=$("#redPacketCount").val();let n=$("#redPacketMsg").val(),s=l;var o=$("#gestureType").val();""!==e&&null!==e&&void 0!==e||(e="random"),0==(s=void 0===s?[]:s).length&&"specify"===e&&$("#chatContentTip").addClass("error").html("<ul><li>请选择红包发送对象</li></ul>"),""===n&&(n="摸鱼者，事竟成！");let i;i="rockPaperScissors"!==e?{type:e,money:t,count:a,msg:n,recivers:s}:{type:e,money:t,count:a,msg:n,recivers:s,gesture:o};t={content:"[redpacket]"+JSON.stringify(i)+"[/redpacket]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()})}),ChatRoom.loadAvatarPendant(),ChatRoom.loadXiaoIceGame(),ChatRoom.initCatchUser(),ChatRoom.charInit("paintCanvas"),$("#barragerBtn").on("click",function(){("none"===$("#barragerContent").css("display")?($("#barragerContent").slideDown(1e3),$("#paintContent")):$("#barragerContent")).slideUp(1e3)}),$("#barragerInput").keydown(function(e){13==e.keyCode&&ChatRoom.sendBarrager()}),$("#paintBtn").on("click",function(){("none"===$("#paintContent").css("display")?($("#paintContent").slideDown(1e3),$("#barragerContent")):$("#paintContent")).slideUp(1e3)}),BarragerColorPicker=new XNColorPicker({color:"#ffffff",selector:"#selectBarragerColor",showhistorycolor:!1,colorTypeOption:"single",autoConfirm:!0,onError:function(e){},onCancel:function(e){},onChange:function(e){},onConfirm:function(e){}}),DarwColorPicker=new XNColorPicker({color:"#000000",selector:"#selectColor",showhistorycolor:!1,colorTypeOption:"single",autoConfirm:!0,onError:function(e){},onCancel:function(e){},onChange:function(e){ChatRoom.changeColor(e.color.rgba)},onConfirm:function(e){ChatRoom.changeColor(e.color.rgba)}}),$("#selectWidth").bind("change",function(){var e=$("#selectWidth").val();ChatRoom.changeWidth(e)}),"true"===(localStorage.getItem("smoothMode")||"false")?ChatRoom.enableSmoothMode():setInterval(ChatRoom.reloadMessages,9e5)},enableSmoothMode:function(){console.log("Smooth mode enabling..."),$("#smoothMode").html("开启"),setInterval(ChatRoom.reloadMessages,3e3)},toggleSmoothMode:function(){let e;e="开启"===$("#smoothMode").html()?"false":"true",localStorage.setItem("smoothMode",e),"true"===e?(Util.notice("success",5e3,"流畅模式已开启，占用内存更小，体验更流畅。"),ChatRoom.enableSmoothMode()):location.reload()},sendBarrager:function(){var e=BarragerColorPicker.color.rgba,t=$("#barragerInput").val(),e={content:"[barrager]"+JSON.stringify({color:e,content:t})+"[/barrager]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(e),success:function(e){0!==e.code?$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>"):$("#barragerInput").val("")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}})},reloadMessages:function(){document.documentElement.scrollTop<=2e3&&ChatRoom.flashScreenQuiet()},flashScreen:function(){NProgress.start(),$("#chats").css("display","none"),page=1;var t=$("#chats>div");if(25<t.length)for(let e=t.length-1;24<e;e--)t[e].remove();setTimeout(function(){$("#chats").css("display","block"),NProgress.done()},150)},flashScreenQuiet:function(){page=1;var t=$("#chats>div");if(25<t.length)for(let e=t.length-1;24<e;e--)t[e].remove()},showSiGuoYar:function(){Util.alert(`
<style>
.dialog-panel {
border-radius: 20px 20px 20px 20px;
border: 0;
box-shadow: none;
}
.dialog-header-bg {
display: none;
}
.dialog-main {
height: 456px;
overflow: auto;
padding: 10px 10px 20px !important;
color: #e1e1e1;
background: url(https://file.fishpi.cn/2023/04/面壁-5e5b04c3.jpg) no-repeat;
background-size: 100% 100%;
background-attachment: fixed;
font-family: STKaiti;
}
.list>ul {
margin-top: 15px;
}
.list>ul>li {
padding: 6px 8px;
border-bottom: none;
}
</style>
<div class="fn-hr5"></div>
<div class="ft__center">
    <div>
        <h2>思過崖</h2>
        <div class="fn-hr5"></div>
        <span>摸魚派倡導自由、友善的交流環境。<br>這裏收留了因不遵守摸魚法則而受到處罰的魚油。</span>
    </div>
    <div class="list">
    <ul id="si-guo-list">
    </ul>
    </div>
</div>`),$.ajax({url:Label.servePath+"/chat-room/si-guo-list",type:"GET",cache:!1,async:!1,success:function(e){var a=e.data;0==a.length&&$("#si-guo-list").prepend('<li style="color: #3caf36; font-weight: bold;">目前沒有受到處罰的魚油，請繼續保持！</li>');for(let t=0;t<a.length;t++){var n=a[t],s=new Date(n.time),o=n.userAvatarURL,i=n.userName,n=n.userNickname;let e=""!=n?n:i;$("#si-guo-list").prepend(`
    <li class="fn__flex menu__item">
        <img class="avatar avatar--mid" style="width: 24px; height: 24px; margin-right: 10px; background-image: none; background-color: transparent;" src="`+o+`">
        <div class="fn__flex-1" style="text-align: left !important;">
            <h2 class="list__user">
                <a target="_blank" href="`+Label.servePath+"/member/"+i+'" style="color: #c0c0c0; text-decoration: none;">'+e+`</a>
            </h2>
            <span class="ft__fade ft__smaller"><a onclick="Util.closeAlert(this);ChatRoom.editor.setValue('合议破戒 `+i+`');ChatRoom.send();$(window).scrollTop(0);" style="cursor: pointer; font-weight: bold;" href="javascript:void(0);">爲他求情</a></span>
        </div>
        <div class="fn__flex-center" style="color: #ff1919; font-weight: bold">
        將於 `+s.getFullYear()+"年"+(s.getMonth()+1<10?"0"+(s.getMonth()+1):s.getMonth()+1)+"月"+s.getDate()+"日 "+s.getHours()+"時"+s.getMinutes()+`分 釋放
        </div>
  
    </li>
                `)}}})},submitCharacter:function(e){var t;0!==linesArray.length?(e=function(e){var e=e.split(","),t=e[0].match(/:(.*?);/)[1],a=atob(e[1]),n=a.length,s=new Uint8Array(n);for(;n--;)s[n]=a.charCodeAt(n);return new Blob([s],{type:t})}(document.getElementById(e).toDataURL()),(t=new FormData).append("file[]",e),$.ajax({url:Label.servePath+"/upload",type:"POST",cache:!1,data:t,processData:!1,contentType:!1,success:function(e){e=e.data.succMap.blob;ChatRoom.editor.setValue(ChatRoom.editor.getValue()+"![涂鸦]("+e+")"),ChatRoom.editor.focus(),ChatRoom.clearCharacter("paintCanvas"),$("#paintContent").slideUp(500)},error:function(e){}}),linesArray=[],$(window).scrollTop(0)):alert("画布为空，无法提交！")},clearCharacter:function(e){e=document.getElementById(e).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),linesArray=[]},revokeChatacter:function(e){0<linesArray.length&&(ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),linesArray.pop(),linesArray.forEach(t=>{ChatRoom.changeColor(t.color),ChatRoom.changeWidth(t.width),ctx.beginPath(),ctx.moveTo(t.point[0].x,t.point[0].y);for(let e=1;e<t.point.length;e++)ctx.lineTo(t.point[e].x,t.point[e].y);ctx.stroke()}))},changeColor:function(e){ctx.fillStyle=ctx.strokeStyle=ctx.shadowColor=e},changeWidth:function(e){ctx.lineWidth=e},charInit:function(e){el=document.getElementById(e),(ctx=el.getContext("2d")).fillStyle=ctx.strokeStyle=ctx.shadowColor="#000",ctx.lineWidth=3,ctx.lineJoin="miter",ctx.lineCap="round",ctx.shadowBlur=2,el.onmousedown=function(e){pointsArray=[],isClick=isDrawing=!0,ctx.beginPath(),x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)},el.onmousemove=function(e){isDrawing&&(isClick=!1,x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke())},el.onmouseup=function(){linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth}),isClick&&(ctx.lineTo(x,y),ctx.stroke()),isDrawing=!1},el.addEventListener("touchstart",function(e){isClick=!0,pointsArray=[],ctx.beginPath(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)},!1),el.addEventListener("touchmove",function(e){isClick=!1,e.preventDefault(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke()},!1),el.addEventListener("touchend",function(e){isClick&&(ctx.lineTo(x,y),ctx.stroke()),linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth})},!1)},setDiscuss:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">修改话题需要16积分，将自动从账户中扣除；<br>最大长度16字符，不合法字符将被自动过滤。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="discuss-new-title">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.updateDiscussData($("#discuss-new-title").val());Util.closeAlert();\'>设置 <span class=\'count\'><svg style=\'vertical-align: -2px;\'><use xlink:href="#iconPoints"></use></svg> 16</span></button>\n</div>\n</div>',"设置话题")},updateDiscussData:function(e){e={content:"[setdiscuss]"+e+"[/setdiscuss]",client:thisClient};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(e),success:function(e){0!==e.code?Util.notice("danger",3e3,e.msg):Util.notice("success",3e3,"话题修改成功，所有人可见。<br>16积分已扣除。")},error:function(e){Util.notice("danger",3e3,e.statusText)}})},useDiscuss:function(){var e=ChatRoom.editor.getValue();ChatRoom.editor.setValue("*`# "+$("#discuss-title").html()+" #`*  "),ChatRoom.editor.insertValue(e,0),ChatRoom.editor.focus()},toggleOnlineAvatar:function(){"none"===$("#chatRoomOnlineCnt").css("display")?($("#chatRoomOnlineCnt").html(Label.onlineAvatarData),setTimeout(function(){$("#toggleAvatarBtn").html('<use xlink:href="#showLess"></use>'),$("#chatRoomOnlineCnt").slideDown(200),setTimeout(function(){Util.listenUserCard()},200)},100)):($("#toggleAvatarBtn").html('<use xlink:href="#showMore"></use>'),$("#chatRoomOnlineCnt").slideUp(200))},confirmed:!1,delEmoji:function(t){if(!0===ChatRoom.confirmed||confirm("确定要删除该表情包吗？")){ChatRoom.confirmed=!0;var a=ChatRoom.getEmojis();for(let e=0;e<a.length;e++)a[e]===t&&a.splice(e,1);a.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:a}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),ChatRoom.loadEmojis(),setTimeout(function(){$("#emojiBtn").click()},50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},loadEmojis:function(){let t=ChatRoom.getEmojis(),a="";for(let e=0;e<t.length;e++)a+=`<button onclick="ChatRoom.editor.setValue(ChatRoom.editor.getValue() + '![图片表情](${t[e]})')">
    <div class="divX"><svg onclick='ChatRoom.delEmoji("${t[e]}");event.cancelBubble =true;' style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg></div>
    <img style='max-height: 50px' class="vditor-emojis__icon" src="${t[e]}">
</button>`;$("#emojis").html(a)},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){var t;ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob?((t=new FileReader).readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?5242880<e.target.result.byteLength?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}):a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){t={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};ChatRoom.addEmoji(t.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",function(e){"13"==e.keyCode&&(ChatRoom.addEmoji($("#fromURL").val()),Util.closeAlert())})},addEmoji:function(){for(let e=0;e<arguments.length;e++){var t=arguments[e],a=ChatRoom.getEmojis();a.reverse();for(let e=0;e<a.length;e++)a[e]===t&&a.splice(e,1);a.push(t),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:a}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),ChatRoom.loadEmojis()},getEmojis:function(){let t;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){t=0===e.code&&""!==e.data?Util.parseArray(e.data):[]}}),t.reverse(),t},isSend:!1,send:function(){var t,e;ChatRoom.isSend||(ChatRoom.isSend=!0,e={content:t=ChatRoom.editor.getValue(),client:thisClient},ChatRoom.editor.setValue(""),$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(e),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?$("#chatContentTip").removeClass("error succ").html(""):($("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>"),ChatRoom.editor.setValue(t))},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>"),ChatRoom.editor.setValue(t)},complete:function(e,t){ChatRoom.isSend=!1,$(".form button.red").removeAttr("disabled").css("opacity","1")}}))},more:function(){NProgress.start(),setTimeout(function(){let e;var t;1!==++page&&(t=(t=$(".chats__item"))[t.length-1],e=$(t).attr("id").replace("chatroom","")),Label.hasMore&&(1===page?$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t];0===$("#chatroom"+t.oId).length&&ChatRoom.renderMsg(t,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}}):$.ajax({url:Label.servePath+"/chat-room/getMessage?size=25&mode=1&oId="+e,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t];0===$("#chatroom"+t.oId).length&&ChatRoom.renderMsg(t,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}})),NProgress.done()},0)},resetMoreBtnListen:function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("details[open]").removeAttr("open")})},groupRevokeProcess:!1,startGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.stopGroupRevoke()"),$("#groupRevoke").html("关闭批量撤回"),Util.notice("warning",6e3,"批量撤回已启动，已在消息中添加便捷撤回按钮。<br>使用完成后请记得关闭此功能。"),ChatRoom.groupRevokeProcess=!0;let e=setInterval(function(){ChatRoom.groupRevokeProcess||($("#chats").empty(),page=0,ChatRoom.more(),clearInterval(e)),$(".chats__item").each(function(){0===$(this).find(".button").length&&($(this).find(".date-bar").css("float","left"),$(this).find(".date-bar").html("<button class='button' onclick='ChatRoom.adminRevoke(\""+$(this).attr("id").replace("chatroom","")+"\")'>撤回</button>"))})},500)},stopGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.startGroupRevoke()"),$("#groupRevoke").html("批量撤回"),Util.notice("success",1500,"批量撤回已关闭。"),ChatRoom.groupRevokeProcess=!1},adminRevoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0!==e.code&&Util.notice("danger",1500,e.msg)}})},shileds:",",shiled:function(e){confirm("友好的交流是沟通的基础, 确定要屏蔽 Ta 吗？\n本次屏蔽仅针对当前页面有效, 刷新后需重新屏蔽！")&&(ChatRoom.shileds+=e+",")},revoke:function(e){confirm("确定要撤回吗？")&&$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code?Util.notice("success",1500,e.msg):Util.notice("danger",1500,e.msg)}})},repeat:function(e){let t="";$.ajax({url:Label.servePath+"/cr/raw/"+e,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,"")}}),ChatRoom.editor.setValue(t),ChatRoom.send(),$(window).scrollTop(0)},report:function(e){confirm("确定举报吗？")&&$.ajax({url:Label.servePath+"/report",type:"POST",cache:!1,data:JSON.stringify({reportDataId:e,reportDataType:3,reportType:49,reportMemo:""}),complete:function(e){0===e.responseJSON.code?Util.alert("一键举报成功，感谢你的帮助！<br>管理员将进行审核，如情况属实系统会为举报人发放积分奖励，并对违规者进行相应处罚。"):Util.alert(e.responseJSON.msg)}})},at:function(e,a,t){if(ChatRoom.editor.focus(),!0===t)ChatRoom.editor.insertValue("@"+e+"  \n",!1);else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=(t=e.replace(/(<!--).*/g,"")).replace(/\n/g,"\n> ")}}),ChatRoom.editor.insertValue(`
##### 引用 @${e} [↩](${Label.servePath}/cr#chatroom${a} "跳转至原消息")  
> ${t}</span>
`,!1)}$(window).scrollTop(0)},renderRedPacket:function(i,e,t,a,n,s){let l=!1,r=-1,c,o;if(void 0!==n&&(c=n.winnerResult,o=n.diceParticles),e===t)for(let e=0;e<i.length;e++){var d=i[e];d.userMoney>r&&(r=d.userMoney)}for(let o=0;o<i.length;o++){var u=i[o],p=u.userMoney,m=u.dice,h=u.userName;h===Label.currentUser&&(void 0!==p?0<p?$("#redPacketIGot").text("抢到了 "+p+" 积分"):0==p?$("#redPacketIGot").text("恭喜你，抢了个寂寞"):$("#redPacketIGot").text("什么运气，你竟然被反向抢红包了"):void 0!==m&&$("#redPacketIGot").text("押注 "+m.chips+" 积分"),l=!0);let e="",t=h;switch(e=void 0!==m?m.bet:e){case"big":t=h+" (押大)";break;case"small":t=h+" (押小)";break;case"leopard":t=h+" (豹子)"}var v=u.time;let a="",n=`<li class="fn__flex menu__item">${a=void 0!==u.avatar?`<img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="${u.avatar}">`:a}
<div class="fn__flex-1" style="text-align: left !important;">
<h2 class="list__user"><a href="${Label.servePath}/member/${h}">${t}</a>
</h2>`;0<p&&p===r?(r=-1,n+="<span class='green small btn'>来自老王的认可</span><br>\n"):0===p?n+="<span class='red small btn'>0溢事件</span><br>\n":p<0&&(n+="<span class='yellow small btn'>抢红包有风险</span><br>\n"),void 0!==c&&(c===m.bet?n+="<span class='green small btn'>运气好而已</span><br>\n":n+="<span class='red small btn'>别玩了</span><br>\n");let s;s=void 0===p&&void 0!==m?m.chips:p,n+=`<span class="ft__fade ft__smaller">${v}</span>
    </div>
    <div class="fn__flex-center">${s} 积分</div>
</li>
`,$("#redPacketList").append(n)}if(l||$("#redPacketIGot").text(Label.currentUser===s?"金主来了":"你错过了这个红包"),void 0!==a&&0<a.length&&-1===(index=a.indexOf(Label.currentUser))&&($("#msg").text("这个红包属于 "+a),$("#redPacketIGot").text(Label.currentUser===s?"金主来了":"这个红包不属于你")),void 0!==c){let e=" ",t=0;for(key in o)t+=o[key];switch(c){case"big":e+=t+"点大";break;case"small":e+=t+"点小";break;case"leopard":e+="豹子通杀"}$("#redPacketIGot").text(o+e)}},bet:function(e){Util.alert('<div class="form fn__flex-column">\n<label id="betRadio">\n  <input type="radio" name="bet" value="big" checked>大\n  <input type="radio" name="bet" value="small">小\n  <input type="radio" name="bet" value="leopard">豹子\n  <div class="ft__smaller ft__fade" style="float: left">筹码</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="100" required="" value="32" id="chipsLabel" name=\'chips\' onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<div class="fn__flex" style="margin-top: 15px">\n  <button class="btn btn--confirm" onclick="ChatRoom.unpackRedPacket('+e+');Util.clearAlert()">押注</button>\n</div>\n</div>',"买定离手"),$("#chipsLabel").on("change",function(){100<$("#chipsLabel").val()&&$("#chipsLabel").val("100"),$("#chipsLabel").val()<=32&&$("#chipsLabel").val("32")})},selectGesture:function(e){Util.alert(`<div class="form fn__flex-column select-center">
<div>
   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/rock.png" onclick="ChatRoom.unpackRedPacket(${e},'0');Util.clearAlert()"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/scissors.png" onclick="ChatRoom.unpackRedPacket(${e},'1');Util.clearAlert()"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   <img width="50" src="${Label.staticServePath}/images/redpacket/gesture/paper.png" onclick="ChatRoom.unpackRedPacket(${e},'2');Util.clearAlert()"/>
</div>
</div>`,"出拳")},unpackRedPacket:function(a,e){null==e&&(e="0"),redPacketMap.set(a,$($("#chatroom"+a).find(".hongbao__item").find("div")[1]).html()),$($("#chatroom"+a).find(".hongbao__item").find("div")[1]).html("红包在路上啦~<br><b>请稍等...</b>"),$("#chatroom"+a).css("pointer-events","none"),$.ajax({url:Label.servePath+"/chat-room/red-packet/open",async:!0,method:"POST",data:JSON.stringify({oId:a,gesture:e,dice:{bet:$("#betRadio>input[name=bet]:checked").val(),chips:$("#betRadio>input[name=chips]").val()}}),success:function(t){if(setTimeout(function(){$($("#chatroom"+a).find(".hongbao__item").find("div")[1]).html(redPacketMap.get(a)),$("#chatroom"+a).css("pointer-events","")},300),-1!==t.code){let e="";void 0!==t.info.gesture&&(e=(Label.currentUser===t.info.userName?"你":t.info.userName)+"出拳:  "+["石头","剪刀","布"][t.info.gesture]),Util.alert(`<style>.dialog-header-bg {border-radius: 4px 4px 0 0; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>
<div class="ft__center">
    <div class="fn__flex-inline">
        <img class="avatar avatar--small" src="${t.info.userAvatarURL48}" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0;">
        <div class="fn__space5"></div>
        <a href="${Label.servePath}/member/${t.info.userName}">${t.info.userName}</a>'s 红包
    </div>
    <div class="fn-hr5"></div>
${e?`<div class="ft__smaller ft__fade">${e}</div>`:""}    <div id = "msg" class="ft__smaller ft__fade">
${t.info.msg}
    </div>
    <div class="hongbao__count" id='redPacketIGot'>抢红包人数较多，加载中...</div>
    <div class="ft__smaller ft__fade">总计 ${t.info.got}/${t.info.count}</div>
</div>
<div class="list"><ul id="redPacketList">
</ul></div>`,"红包"),ChatRoom.renderRedPacket(t.who,t.info.count,t.info.got,t.recivers,t.diceRet,t.info.userName),t.info.count===t.info.got&&($("#chatroom"+a).find(".hongbao__item").css("opacity",".36").attr("onclick","ChatRoom.unpackRedPacket("+a+")"),$("#chatroom"+a).find(".hongbao__item").hasClass("opened")||$("#chatroom"+a).find(".hongbao__item").addClass("opened"),!0===t.dice?$("#chatroom"+a).find(".redPacketDesc").html("已开盘"):$("#chatroom"+a).find(".redPacketDesc").html("已经被抢光啦"))}else Util.alert(t.msg)},error:function(e){Util.alert(e.msg)}})},plusOne:function(){ChatRoom.editor.setValue(Label.latestMessage),ChatRoom.send()},renderMsg:function(o,a){if(!(0<ChatRoom.shileds.indexOf(o.userName))){var i=o.userName,l=o.content,r=o.md||"",c=o.userAvatarURL;if(!a&&catchUsers.includes(i)&&-1==l.indexOf('"msgType":"redPacket"')){var d='<div class="robot-msg-item"><div class="avatar" style="background-image: url('+c+')"></div><div class="robot-msg-content"><div class="robot-username"><p>'+i+"</p></div> "+l+' <div class="fn__right" style="margin-top: 5px; font-size: 10px;">'+o.time+"</div></div></div>";ChatRoom.addRobotMsg(d)}else if(!a&&$("#catch-word").prop("checked")&&-1==l.indexOf('"msgType":"redPacket"')&&(r.startsWith("鸽 ")||r.startsWith("小冰 ")||r.startsWith("凌 ")||r.startsWith("ida "))){d='<div class="robot-msg-item"><div class="avatar" style="background-image: url('+c+')"></div><div class="robot-msg-content"><div class="robot-username"><p>'+i+"</p></div> "+l+' <div class="fn__right" style="margin-top: 5px; font-size: 10px;">'+o.time+"</div></div></div>";ChatRoom.addRobotMsg(d)}else{let e=!1;r=Label.latestMessage===o.md;try{var u=$.parseJSON(o.content.replace("<p>","").replace("</p>",""));if("redPacket"===u.msgType){e=!0;let t="未知类型红包",a="ChatRoom.unpackRedPacket('"+o.oId+"')";switch(u.type){case"random":t="拼手气红包";break;case"average":t="普通红包";break;case"specify":t="专属红包";break;case"heartbeat":t="心跳红包 (慎抢)";break;case"rockPaperScissors":t="石头剪刀布红包",u.senderId!=Label.currentUserId&&(a="");break;case"dice":if(t="摇骰子",u.senderId!==Label.currentUserId){let e=!1;for(idx in u.who)if(u.who[idx].userId===Label.currentUserId){e=!0;break}e||(a="ChatRoom.bet('"+o.oId+"')")}}if(Number(u.count)===Number(u.got)){let e="已经被抢光啦";"dice"===u.type&&(e="已开盘"),o.content='<div style="opacity: .36;" class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+o.oId+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+u.msg+"<br><b>"+t+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+u.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n'+e+"\n        </div>\n    </div>\n</div>"}else"rockPaperScissors"===u.type&&u.senderId!=Label.currentUserId?o.content='<div class="hongbao__item fn__flex-inline" >\n    <div class="hongbao__finger_guessing">\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+o.oId+',\'0\');"></div>\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+o.oId+',\'1\');"></div>\n        <div class="hongbao__finger_guessing_icon" onclick="event.stopPropagation();Util.clearAlert();ChatRoom.unpackRedPacket('+o.oId+',\'2\');"></div>\n    </div>\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+u.msg+"<br><b>"+t+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+u.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>':o.content='<div class="hongbao__item fn__flex-inline" onclick="'+a+'">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+u.msg+"<br><b>"+t+'</b></div>\n        <div><svg style="vertical-align: -2px; width: 13px; height: 13px"><use xlink:href="#coin"></use></svg> '+u.money+'</div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>'}}catch(e){}let t="",s="<a onclick=\"ChatRoom.shiled('"+o.userName+"')\" class=\"item\" style='color: red'>屏蔽Ta</a>\n";void 0!==o.userNickname&&""!==o.userNickname?o.userNickname=o.userNickname+" ("+o.userName+")":o.userNickname=o.userName,Label.currentUser===o.userName&&(t=" chats__item--me",s='<a onclick="ChatRoom.revoke('+o.oId+')" class="item">撤回</a>\n'),Label.level3Permitted&&(s='<a onclick="ChatRoom.revoke('+o.oId+')" class="item"><svg><use xlink:href="#administration"></use></svg> 撤回</a>\n');try{var p=o.content.replace("<p>","").replace("</p>",""),m=Util.parseDom(p);let t=!1,a="",n=0;for(let e=0;e<m.length;e++){var h=m.item(e);void 0!==h.src&&(t=!0,0!==n&&(a+=","),a+="'"+h.src+"'",n++)}t&&(s+='<a onclick="ChatRoom.addEmoji('+a+')" class="item">一键收藏表情</a>')}catch(e){}let n='<div class="fn-none">';if(n=(n+='<div id="chatroom'+o.oId+'" class="fn__flex chats__item'+t+'">\n    <a href="/member/'+o.userName+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+o.userName+'" style="background-image: url(\''+o.userAvatarURL+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n')+('<div id="userName" class="ft__fade ft__smaller" style="padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+o.userNickname+"</span>&nbsp;\n"),void 0!==o.sysMetal&&""!==o.sysMetal){var v=JSON.parse(o.sysMetal).list;if(void 0!==v)for(let e=0;e<v.length;e++){var f=v[e];n+="<img title='"+f.name+" - "+f.description+"' src='"+Util.genMiniMetal(f.attr)+"'/>"}}if(n=(n+="</div>")+('        <div class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'" style="margin-top: 3px">\n            '+o.content+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+o.time+'\n                <span class="fn__space5"></span>\n'),void 0!==o.client&&""!==o.client){var g=o.client.split("/")[0],b=o.client.split("/")[1];switch(g){case"Web":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-fish"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Bird":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-bird"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Dart":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-dart"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"ElvesOnline":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-moon"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Mobile":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-mobile"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Windows":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-windows"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Linux":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-linux"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"IceNet":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-icenet"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Extension":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-extension"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Edge":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-edge"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Other":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-other"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"PC":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-pc2"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"iOS":case"macOS":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-apple"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Android":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-apk"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Chrome":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-chrome"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"VSCode":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-vscode"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"IDEA":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-idea"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Python":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-python"></use></svg></span>')+'<span class="fn__space5"></span>\n';break;case"Golang":n=n+('<span class="tooltipped tooltipped-n" aria-label="'+g+" "+b+'"><svg style="vertical-align: -3px;"><use xlink:href="#ic-golang"></use></svg></span>')+'<span class="fn__space5"></span>\n'}}if(e?n+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+o.userName+"', '"+o.oId+'\', true)" class="item">@'+o.userName+"</a>\n                        <a onclick=\"ChatRoom.report('"+o.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n                    </details-menu>\n                </details>\n':n+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+o.userName+"', '"+o.oId+'\', true)" class="item">@'+o.userName+"</a>\n                        <a onclick=\"ChatRoom.at('"+o.userName+"', '"+o.oId+'\', false)" class="item">引用</a>\n                        <a onclick="ChatRoom.repeat(\''+o.oId+'\')" class="item">复读机</a>\n                        <a onclick="ChatRoom.report(\''+o.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n'+s+"                    </details-menu>\n                </details>\n",n+="        </div>\n    </div>\n</div></div>",a){$("#chats").append(n);c=$("#chats>div.fn-none");c.show(),c.removeClass("fn-none")}else if(r){let t=++Label.plusN;1==t&&($("#chats").prepend("<div id='stacked' class='fn__flex' style='position:relative;display:none;'><span id='plusOne' onclick='ChatRoom.plusOne()' style='display:block;margin-left: 20px'><svg style='width: 30px; height: 20px; cursor: pointer;'><use xlink:href='#plusOneIcon'></use></svg></span></div>"),i=$("#chats>div.latest"),$("#stacked").prepend(i),i.find("#userName").show(),i.removeClass("latest"));let a=$("#stacked");1!=t&&a.fadeOut(100),setTimeout(function(){a.append(n),a.height(a.height()+27+"px");var e=$("#stacked>div.fn-none");e.show(),e.css("left",9*t+"px"),e.css("top",27*t+"px"),e.css("position","absolute"),e.find(".chats__content").css("background-color",t%2==0?"rgb(240 245 254)":"rgb(245 245 245)"),e.removeClass("fn-none"),a.fadeIn(200)},100)}else{$("#plusOne").remove(),o.md&&(Label.latestMessage=o.md,Label.plusN=0);l=$("#chats"),d=(l.find(".latest").removeClass("latest"),l.prepend(n),$("#chats>div.fn-none"));d.slideDown(200),d.addClass("latest"),d.removeClass("fn-none")}}}},imgViewer:null,imgWaitting:!1,imageViewer:function(){if(!this.imgViewer||$("div.vditor-reset.ft__smaller img:not(.ft__smaller,.emoji,.ext-emoji,*[src*='shield'],*[src*='/gen?'])").length!==this.imgViewer.length){this.imgViewer=this.imgViewer||new Viewer(document.querySelector("#chats"),{inline:!1,className:"PWLimgViwer",filter:e=>!e.parentElement.classList.contains("ft__smaller")&&!e.parentElement.classList.contains("ext-emoji")&&!e.classList.contains("emoji")&&e.src.indexOf("shield")<0&&e.src.indexOf("/gen?")<0,title(){let e=this.images[$(".PWLimgViwer .viewer-active").attr("data-index")];for(;!(e=e.parentElement).querySelector(".avatar"););return"From @"+e.querySelector(".avatar").getAttribute("aria-label")}});const e=function(){return setTimeout(()=>{ChatRoom.imgViewer.isShown?e():(ChatRoom.imgWaitting=!1,ChatRoom.imgViewer.update())},1e3),!0};this.imgWaitting=this.imgWaitting||e()}},iceWs:"",IceGameCK:localStorage.getItem("IceGameCK")||null,loadXiaoIceGame:function(){iceWs=new WebSocket("wss://game.yuis.cc/wss");let e;iceWs.onopen=function(){iceWs.send(JSON.stringify({type:"setUser",user:Label.currentUser,ck:ChatRoom.IceGameCK,uid:Label.currentUserId})),e=setInterval(()=>{iceWs.send(JSON.stringify({type:"hb"}))},15e3)},iceWs.onclose=function(){$("#iceMsgList").prepend(`<div class="ice-msg-item">
                    <div class="ice-msg-content">小冰网络失去连接</div>
                  </div>`)},iceWs.onerror=function(e){$("#iceMsgList").prepend(`<div class="ice-msg-item">
                    <div class="ice-msg-content">小冰网络维护中...</div>
                  </div>`)},iceWs.onmessage=function(e){var t,e=JSON.parse(e.data);"all"!==e.user&&e.user!==Label.currentUser||(t=`<div class="ice-msg-item">
                    <div class="ice-msg-content">${e.msg}</div>
                  </div>`,$("#iceMsgList").prepend(t)),"setCK"===e.type&&(ChatRoom.IceGameCK=e.ck,localStorage.setItem("IceGameCK",e.ck))},$("#xiaoIceGameBtn").click(function(){$("#xiaoIceGameBox").show(200),$("#xiaoIceGameBtn").hide(200),setTimeout(()=>{$("#xiaoIceGameBox").addClass("active")},220)}),$("#iceClose").click(function(){var e=$("#xiaoIceGameBox");setTimeout(()=>{$(".ice-chat-input").val(""),$("#xiaoIceGameBox").hide(200),$("#xiaoIceGameBtn").show(200)},e.hasClass("active")?420:1),e.removeClass("active")}),$("#iceMinimize").click(function(){$("#xiaoIceGameBox").toggleClass("active")}),$("#iceSendMsg").click(ChatRoom.sendIceMsg),$(".ice-chat-input").bind("keypress",function(e){13===e.keyCode&&(e.preventDefault(),ChatRoom.sendIceMsg())})},sendIceMsg:function(){var e=$(".ice-chat-input").val(),t=($(".ice-chat-input").val(""),`<div class="ice-msg-item me">
                    <div class="ice-msg-content">${e}</div>
                  </div>`);$("#iceMsgList").prepend(t);let a="gameMsg";console.log(/(登录)/.test(e)),/(登录)/.test(e)&&(a="login"),iceWs.send(JSON.stringify({type:a,ck:ChatRoom.IceGameCK,msg:e}))},addRobotMsg:function(e,t){$("#robotMsgList").prepend(e);$(".robot-msg-item")&&50<$(".robot-msg-item").length&&$(".robot-msg-item:gt(n-1)").remove()},changeCatchUser:function(e){var t;e&&0<e.length?(t='<div class="robot-msg-item"><div class="robot-msg-content">当前捕获用户:'+e+"</div></div></div>",$("#robotMsgList").prepend(t)):$("#robotMsgList").prepend('<div class="robot-msg-item"><div class="robot-msg-content">当前不存在需要捕获的用户</div></div></div>'),window.localStorage.robot_list=e,catchUsers=e.split(",")},initCatchUser:function(){$("#robotBtn").click(function(){$("#robotBox").show(200),$("#robotBtn").hide(200),setTimeout(()=>{$("#robotBox").addClass("robot-active"),$("#robotBox").attr("style","height:"+(window.innerHeight-25-58)+"px"),$("#robotMsgList").attr("style","height:"+(window.innerHeight-85-58)+"px")},220)}),$("#robotClose").click(function(){var e=$("#robotBox");setTimeout(()=>{$(".robot-chat-input").val(""),$("#robotBox").hide(200),$("#robotBtn").show(200)},e.hasClass("robot-active")?420:1),e.removeClass("robot-active"),e.css("height","")}),$("#robotMinimize").click(function(){$("#robotBox").toggleClass("robot-active")}),$("#clearRobotMsg").click(function(){$(".robot-msg-item").remove()}),$("#catch-word").click(function(){window.localStorage["catch-word-flag"]=$("#catch-word").prop("checked")}),$("#changeCatchUsers").click(function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">将捕获的用户id填写到下方输入框；<br>多个用户id的情况用英文逗号隔开。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="robot-catch-user">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.changeCatchUser($("#robot-catch-user").val());Util.closeAlert();\'>确认</button>\n</div>\n</div>',"编辑捕获用户列表"),$("#robot-catch-user").val(window.localStorage.robot_list||"")});var e=window.localStorage.robot_list||"";ChatRoom.changeCatchUser(e);let t=!1;"true"===window.localStorage["catch-word-flag"]&&(t=!0),$("#catch-word").prop("checked",t)},loadAvatarPendant:function(){var e=(new Date).getFullYear(),t=(t=((new Date).getMonth()+1).toString())[1]?t:"0"+t,a=(new Date).getDate(),n=e+`-${t}-`+a,s={2022:["2022-01-31","2022-02-06"],2023:["2023-01-21","2023-01-27"],2024:["2024-02-09","2024-02-15"],2025:["2025-01-28","2025-02-03"],2026:["2026-02-16","2026-02-22"],2027:["2027-02-06","2027-02-12"]},o={2022:["2022-09-10","2022-09-12"],2023:["2023-09-29","2023-10-01"],2024:["2024-09-17","2024-09-19"],2025:["2025-10-06","2025-10-09"],2026:["2026-09-25","2026-09-27"],2027:["2027-09-15","2027-09-17"]},i=document.querySelector("body");10==t&&a<=7?i.classList.add("NationalDay"):12==t&&24<=a&&12==t&&a<=25?i.classList.add("Christmas"):(t=new Date(n).getTime(),new Date(o[e][0]).getTime()<=t&&new Date(o[e][1]).getTime()>=t?i.classList.add("MidAutumnFestival"):new Date(s[e][0]).getTime()<=t&&new Date(s[e][1]).getTime()>=t&&i.classList.add("SpringFestival"))},isMobile:function(){for(var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],a=!1,n=0;n<t.length;n++)if(0<e.indexOf(t[n])){a=!0;break}var s=window.screen.width,o=window.screen.height;return a=325<s&&o<750?!0:a}});