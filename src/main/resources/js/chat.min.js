var Chat={page:1,toUser:"",init:function(e){let t;if(void 0!==e){Chat.page=1;try{Chat.ws.close()}catch(e){}$("#chats").html(""),$("#chatTo"+Chat.toUser).css("background-color",""),Chat.toUser="",Chat.noMore=!1,t=e}else t=getQueryVariable("toUser");Chat.toUser=t;let a=window.location.href;var e=a.split("?")[0];history.pushState("","",e),e=$.ajax({url:Label.servePath+"/chat/get-list?apiKey="+apiKey,type:"GET",async:!1,success:function(t){if(0===t.result){let e=t.data;0!==e.length&&e.forEach(e=>{"文件传输助手"===e.receiverUserName?$("#fileTransferMsg").html(e.preview):e.senderUserName!=Label.currentUserName?$("#chatTo"+e.senderUserName).length<=0&&Chat.addToMessageList(e.senderUserName,e.senderAvatar,e.preview):$("#chatTo"+e.receiverUserName).length<=0&&Chat.addToMessageList(e.receiverUserName,e.receiverAvatar,e.preview)})}}}),$.when(e).done(function(){var e;""!==t&&"FileTransfer"!==t&&(e=$.ajax({url:Label.servePath+"/user/"+t,type:"GET",success:function(e){-1===e.code&&(alert("指定的用户名不存在，请检查后重试！"),location.href=Label.servePath+"/chat"),$("#chatTo"+e.userName).length<=0&&Chat.addToMessageList(e.userName,e.userAvatarURL,"&nbsp;"),t=e.userName,Chat.toUser=t}})),$.when(e).done(function(){var e;""===t?($("#chatStatus").html('请在左侧列表选择最近聊天的成员，或直接发起聊天。<br><br><input class="form" id="chatWithInput" placeholder="输入用户名">&nbsp;<button onclick="Chat.startAChat()">发起聊天</button>'),$("#chatWithInput").keypress(function(e){13==e.which&&Chat.startAChat()})):($("#chatStatus").html('和 <a href="'+Label.servePath+"/member/"+t+'">'+t+"</a> 聊天中"),$("#buttons").show(),$(".pagination__chat").show(),Chat.editor=Util.newVditor({id:"messageContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},height:150,placeholder:"说点什么吧，友善第一哦。",toolbar:["emoji","link","upload","edit-mode",{name:"more",toolbar:["insert-after","fullscreen","preview","info","help"]}],ctrlEnter:function(){Chat.send()}}),Chat.ws=new WebSocket(chatChannelURL+t),Chat.ws.onopen=function(){console.log("Connected to chat channel websocket.")},Chat.ws.onmessage=function(e){var t,a,s,n,i,r,o,l,c=JSON.parse(e.data);-1===c.code?$("#chatContentTip").addClass("error").html("<ul><li>"+c.msg+"</li></ul>"):($("#chatContentTip").removeClass("error succ").html(""),t=c.oId,a=c.toId,c.fromId,s=c.time,n=c.content,i=c.preview.substring(0,10),l=10<c.preview.length?"...":"",c.user_session,r=c.senderUserName,o=c.senderAvatar,e=c.receiverUserName,c.receiverAvatar,r===Label.currentUserName?(Chat.addSelfMsg(t,r,o,n,s,!1),$("#chatTo"+e).find("span").html(i+l),c=$("#chatTo"+e).prop("outerHTML"),$("#chatTo"+e).remove(),$("#chatMessageList").prepend(c),"1000000000086"===a&&$("#chatToFileTransfer").find("span").html(i+l)):(Chat.addTargetMsg(t,r,o,n,s,!1),$("#chatTo"+r).find("span").html(i+l),l=$("#chatTo"+r).prop("outerHTML"),$("#chatTo"+r).remove(),$("#chatMessageList").prepend(l),$.ajax({url:Label.servePath+"/chat/mark-as-read?apiKey="+apiKey+"&fromUser="+Chat.toUser,type:"GET"})))},Chat.ws.onclose=function(){console.log("Disconnected to chat channel websocket.")},Chat.ws.onerror=function(e){console.log("ERROR",e)},Chat.loadMore(),$(window).scroll(function(){var e=$(this).scrollTop();$(document).height()<=e+$(this).height()+500&&Chat.loadMore()}),$.ajax({url:Label.servePath+"/chat/mark-as-read?apiKey="+apiKey+"&fromUser="+Chat.toUser,type:"GET",async:!1}),e=$.ajax({url:Label.servePath+"/chat/has-unread?apiKey="+apiKey,type:"GET",async:!1,success:function(e){e.result;let t=e.data;t.forEach(e=>{$("#chatTo"+e.senderUserName).css("background-color","#fff4eb")})}}),$.when(e).done(function(){$("#chatTo"+t).css("background-color","#f1f1f1")}))})})},startAChat(){var e=$("#chatWithInput").val();""!==e&&Chat.init(e)},noMore:!1,moreLock:!1,loadMore(){Chat.moreLock||(Chat.moreLock=!0,Chat.noMore||$.ajax({url:Label.servePath+"/chat/get-message?apiKey="+apiKey+"&toUser="+Chat.toUser+"&page="+Chat.page+"&pageSize=20",type:"GET",async:!1,success:function(e){try{e.data.length}catch(e){Chat.noMore=!0}Chat.noMore||(Chat.page++,e.data.forEach(e=>{var t=e.oId,a=(e.toId,e.fromId,e.time),s=e.content,n=(e.preview.substring(0,10),e.preview.length,e.user_session,e.senderUserName),i=e.senderAvatar;e.receiverUserName,e.receiverAvatar;n===Label.currentUserName?Chat.addSelfMsg(t,n,i,s,a,!0):Chat.addTargetMsg(t,n,i,s,a,!0)}))}}),Chat.moreLock=!1)},send(){var e=Chat.editor.getValue();1024<e.length?$("#chatContentTip").addClass("error").html("<ul><li>发送失败：超过 1024 字符，请修改后重试。</li></ul>"):(Chat.ws.send(e),Chat.editor.setValue(""))},addToMessageList(e,t,a){var s=10<a.length?"...":"";$("#chatMessageList").append('<div class="module-panel" id="chatTo'+e+'" style="padding: 10px 15px;cursor: pointer" onclick="Chat.init(\''+e+'\')"\n    <nav class="home-menu">\n        <div class="avatar"\n             style="display: inline-block; background-image:url('+t+')">\n        </div>\n        <div style="display: inline-block; vertical-align: -12px;">\n            '+e+'<br>\n            <span style="color: #868888">'+a.substring(0,10)+s+"</span>\n        </div>\n    </nav>\n</div>"),"none"===$("#messageListPanel").css("display")&&$("#messageListPanel").show()},addSelfMsg(e,t,a,s,n,i){!0===i?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+t+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+t+'"\n             style="background-image: url('+a+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n        </div>\n    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+t+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+t+'"\n             style="background-image: url('+a+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n        </div>\n    </div>\n</div>"),Util.listenUserCard()},addTargetMsg(e,t,a,s,n,i){!0===i?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+t+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+t+'"\n             style="background-image: url('+a+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n        </div>\n    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+t+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+t+'"\n             style="background-image: url('+a+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n        </div>\n    </div>\n</div>"),Util.listenUserCard()},markAllAsRead(){$.ajax({url:Label.servePath+"/chat/mark-all-as-read?apiKey="+apiKey,type:"GET",success:function(e){e.users.forEach(e=>{$("#chatTo"+e).css("background-color","")})}})},loadEmojis:function(){$("#emojis").html("");var t=Chat.getEmojis();for(let e=0;e<t.length;e++)$("#emojis").append('<button>\n    <div class="divX" onclick=\'Chat.delEmoji("'+t[e]+'")\'>\n        <svg style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg>\n    </div>    <img style=\'max-height: 50px\' onclick="Chat.editor.setValue(Chat.editor.getValue() + \'![图片表情]('+t[e]+')\')" class="vditor-emojis__icon" src="'+t[e]+'">\n</button>')},confirmed:!1,delEmoji:function(a){if(!0===Chat.confirmed||confirm("确定要删除该表情包吗？")){Chat.confirmed=!0;let t=Chat.getEmojis();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),Chat.loadEmojis(),setTimeout(function(){$("#emojiBtn").click()},50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){var t;ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob?((t=new FileReader).readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?5242880<e.target.result.byteLength?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}):a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){t={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};Chat.addEmoji(t.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column" style="border: none;width: 100%;box-shadow: none;background-color: #ffffff;padding: 0;">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'Chat.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",function(e){"13"==e.keyCode&&(Chat.addEmoji($("#fromURL").val()),Util.closeAlert())})},addEmoji:function(){for(let e=0;e<arguments.length;e++){var a=arguments[e];let t=Chat.getEmojis();t.reverse();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.push(a),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),Chat.loadEmojis()},getEmojis:function(){let t;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){t=0===e.code&&""!==e.data?Util.parseArray(e.data):[]}}),t.reverse(),t}};function getQueryVariable(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var s=t[a].split("=");if(s[0]==e)return s[1]}return""}$(document).ready(function(){Chat.init(),$("#sendChatBtn").on("click",function(){Chat.send()}),$("#chats").on("click",".vditor-reset img",function(e){var t;$(this).hasClass("emoji")||1===$(this).closest(".editor-panel").length||1===$(this).closest(".ad").length||(t=$(this),$("body").append('<div class="img-preview" onclick="$(this).remove()"><img src="'+t.attr("src").split("?imageView2")[0]+'" onload="Article.previewImgAfterLoading()"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"}))}),$(window).scroll(function(){1<$(this).scrollTop()?$("#goToTop").fadeIn():$("#goToTop").fadeOut()}),$("#goToTop a").click(function(){return $("html,body").animate({scrollTop:0},800),!1}),$("body").click(function(){$("details[open]").removeAttr("open")}),Chat.listenUploadEmojis(),Chat.loadEmojis(),$("#emojiBtn").on("click",function(){$("#emojiList").hasClass("showList")?$("#emojiList").removeClass("showList"):($("#emojiList").addClass("showList"),setTimeout(function(){$("body").unbind(),$("body").click(function(){$("#emojiList").removeClass("showList"),$("body").unbind(),$("body").click(function(e){$("details[open]").removeAttr("open"),"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()})})},100))})});